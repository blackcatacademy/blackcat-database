# Scripts Guide

This reference covers every script under `scripts/` (excluding the `schema/` and `templates/` subtrees). It explains why each tool exists, when to run it, and the key inputs or precautions to keep in mind.

## Developer Workflow

| Script | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/dev/Dev-Workflow.ps1` | Launches a PowerShell GUI that walks developers through the full regeneration + test pipeline and optionally commits/pushes the results. | `pwsh ./scripts/dev/Dev-Workflow.ps1` inside `blackcat-database`. Pick **Automatic**, **Semi-auto**, or **Manual** mode, choose Developer (local-only) or Super-admin (allows pushes), enter commit messages, choose steps, and click *Start*. | Tabbed Pipeline/Toolbox layout keeps the log visible while exposing one-click toggles for Docker infra, Dockerized tests, PHPStan (`phpstan.neon`), the secrets scanner, the Prometheus/Grafana/Loki stack (with optional Grafana auto-open), and Terraform plan/apply. The Generate-PHP step captures warnings in-line, skipped/failed steps still inject warnings into the package + umbrella commits, missing packages force LICENSE enforcement, change detection can auto-scope docs/code/license-only flows, and the window ends by reminding you to @mention Codex on the PR. Replace `scripts/dev/assets/workflow-bg.png` if you want to customize the background. |
| `scripts/dev/Dev-Observability.ps1` | Controls the local Prometheus + Grafana + Loki stack used for telemetry experiments. | `pwsh ./scripts/dev/Dev-Observability.ps1 -Action start|stop|status|restart [-NoBrowser]`. The stack is defined in `scripts/dev/observability-compose.yml` and mounts the shared configs from `monitoring/` and `provisioning/`. | When launched, `docker compose` spins up Loki, Promtail, Prometheus (ingesting `monitoring/bench_alerts.yml`), and Grafana (auto-provisioned datasources/dashboards). Credentials default to `admin / devpass` at http://localhost:3000. Use `-Pull` to refresh images and `-NoBrowser` to skip auto-opening Grafana. |

## Benchmarks

| Script | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/bench/Run-Bench.ps1` | Orchestrates a full benchmark run (seeds data, spawns PHP workers, waits for completion). | `pwsh scripts/bench/Run-Bench.ps1 -Dsn "<pdo dsn>" -User foo -Pass bar -Mode select|seek -Concurrency 4 -Duration 60 -OutDir bench/results` | Requires PHP CLI in `PATH`. Writes CSVs per worker, so ensure `bench/results` is writable and cleaned between runs. |
| `scripts/bench/BenchSchema.php` | Creates the target benchmark table and seeds it with random rows suited for paging tests. | `php scripts/bench/BenchSchema.php --dsn="pgsql:..." --seed=50000 --table=bench_items` before running workers. | Applies driver-aware schema (Postgres vs MySQL) and keeps `title` unique. |
| `scripts/bench/BenchWorker.php` | Legacy worker used by `Run-Bench.ps1`; performs simple select/seek loops and writes progress to CSV. | Normally invoked by `Run-Bench`; can be run standalone with `php scripts/bench/BenchWorker.php --dsn=... --mode=seek --duration=30 --out=worker.csv`. | Designed for quick multi-process fan-out; uses OFFSET on MySQL < 8.0. |
| `scripts/bench/Bench-Worker.php` | Newer synthetic workload with selectable modes (`select`, `seek`, `upsert`) and optional throttling/jitter. | `php scripts/bench/Bench-Worker.php --mode=upsert --dsn=... --sleepMs=5 --duration=120 --out=worker.jsonl`. | Ensures schema automatically, supports ON CONFLICT / ON DUPLICATE semantics; useful for targeted experiments. |
| `scripts/bench/Bench-Plot.py` | Consolidates worker CSVs, emits latency histograms/timeseries and machine-readable metrics. | `python scripts/bench/Bench-Plot.py --glob bench/results/*.csv --outdir bench/plots` after a run. | Produces PNGs (`latency_histogram_ci.png`, `latency_timeseries_ci.png`) plus `metrics.json` and prints `BENCH_P95`/`BENCH_AVG` for CI exports. |
| `scripts/bench/Bench-PrometheusServer.php` | Tiny HTTP server that exposes bench CSVs as Prometheus metrics. | `php -S 0.0.0.0:9101 scripts/bench/Bench-PrometheusServer.php` and query `/metrics?CSV_GLOB=...&DB=postgres&MODE=seek`. | Handy during local perf runs; configure via env or query params (CSV glob, db name, mode, table). |
| `scripts/bench/Bench-PrometheusTextfile.ps1` | Converts CSVs into node-exporter textfile metrics for scraping. | `pwsh scripts/bench/Bench-PrometheusTextfile.ps1 -CsvGlob bench/results/*.csv -OutPath /var/lib/node_exporter/textfile/bench.prom`. | Emits histogram buckets + counters. Schedule it alongside node exporter’s textfile collector. |
| `scripts/bench/Bench-UploadToBigQuery.ps1` | Streams bench CSV data to BigQuery (optionally creating dataset/table). | `pwsh scripts/bench/Bench-UploadToBigQuery.ps1 -CsvGlob bench/results/*.csv -ProjectId my-prj -Dataset bench -Table ops -Ensure`. | Needs an access token (either provided or via `gcloud auth`). Sets schema for latency/rows/labels. |
| `scripts/bench/Bench-UploadToElastic.ps1` | Bulk-ingests a CSV into an Elasticsearch index for ad-hoc Kibana dashboards. | `pwsh scripts/bench/Bench-UploadToElastic.ps1 -CsvPath bench/results/worker_1.csv -EsUrl http://es:9200 -Index bench-logs`. | Automatically creates a simple mapping if the index is missing; pushes documents in `_bulk` batches of 1 000. |
| `scripts/bench/Bench-UploadToLoki.ps1` | Ships bench runs to Grafana Loki (one log stream per job/db/mode/table). | `pwsh scripts/bench/Bench-UploadToLoki.ps1 -CsvPath bench/results/worker_1.csv -LokiUrl http://loki:3100/loki/api/v1/push -Job bench -Db postgres`. | Converts timestamps to Unix nanoseconds. Use `-DryRun` to validate payloads without pushing. |
| `scripts/bench/PG-PerfDigest.php` | Captures `pg_stat_statements` top queries and emits JSON/Markdown digests. | `php scripts/bench/PG-PerfDigest.php --dsn=pgsql:... --out perf --limit 30` after a run. | Ensures the extension is present and truncates queries to 500 chars for reports. |
| `scripts/bench/PerfDigest-Plot.py` | Visualizes the `PG-PerfDigest` output by bar-charting mean query time. | `python scripts/bench/PerfDigest-Plot.py --in perf/digest.json --outdir perf/plots`. | Produces a PNG chart of the top 10 offenders for quick regression spotting. |
| `scripts/bench/Chaos.php` | Minimal chaos/lock killer that stresses pessimistic locking or session kills. | `php scripts/bench/Chaos.php --dsn=... --action=lock|kill`. | `lock` mode runs paired updates to test wait timeouts; `kill` terminates the current backend (Postgres-only). |

## Database Operations

| Script | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/dbops/Anonymize-SqlDump.ps1` | Deterministically obfuscates SQL dumps (emails, JSON names, `name=` assignments) via HMAC. | `pwsh scripts/dbops/Anonymize-SqlDump.ps1 -InputPath raw.sql -OutputPath clean.sql -Secret "$(uuidgen)"` before sharing dumps. | Works on text input; adjust regexes if schema uses different field names. |
| `scripts/dbops/MySQL-BackupRestore.sh` | Smoke-tests a MySQL/MariaDB backup by dumping, restoring into `restore_smoke`, and counting tables. | `bash scripts/dbops/MySQL-BackupRestore.sh "mysql:host=...;dbname=foo" user pass`. | Leaves no DB behind; fails if restored schema has zero tables. |
| `scripts/dbops/PG-BackupRestore.sh` | Same as above for Postgres (custom-format dump + restore). | `bash scripts/dbops/PG-BackupRestore.sh "pgsql:host=...;dbname=foo" user pass`. | Requires `pg_dump`, `createdb`, `pg_restore`, `psql`, and `dropdb`. |
| `scripts/dbops/PG-Tune-WorkMem.ps1` | Quick heuristic for `work_mem` based on EXPLAIN output rows. | `pwsh scripts/dbops/PG-Tune-WorkMem.ps1 -ExplainPath explain.txt` after capturing EXPLAIN ANALYZE. | Prints suggested kilobytes; good starting point before fine tuning. |
| `scripts/dbops/TlsMatrix.php` | Tests PG `sslmode` variants against a DSN and records which ones succeed. | `php scripts/dbops/TlsMatrix.php --dsn="pgsql:..." --variants="disable,allow,require,verify-full" --out tls`. | Outputs JSON plus `SECURE_OK`/`INSECURE_ONLY`; use to verify cluster TLS posture. |

## Documentation Generators

| Script | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/docs/Changelog-FromCommits.ps1` | Produces a simple release-note Markdown file from a commit range (Conventional Commits). | `pwsh scripts/docs/Changelog-FromCommits.ps1 -From v1.2.0 -To HEAD -OutPath docs/RELEASE_NOTES.md`. | Groups by type (`feat`, `fix`, etc.); intended for quick umbrella release previews. |
| `scripts/docs/New-DocsIndex.ps1` | Rebuilds `PACKAGES.md` listing all submodules with README/Definition/Changelog links. | `pwsh scripts/docs/New-DocsIndex.ps1 -MapPath scripts/schema/schema-map-postgres.yaml -PackagesDir packages -OutPath PACKAGES.md`. | Uses table presence to tick off doc completeness; rerun after generating per-package docs. |
| `scripts/docs/New-PackageChangelogs.ps1` | Walks git history per package (based on schema map) and writes `CHANGELOG.md` into each submodule. | `pwsh scripts/docs/New-PackageChangelogs.ps1 -MapPath scripts/schema/schema-map-postgres.yaml -PackagesDir packages [-FromRef v0.9.0 -ToRef HEAD -Force]`. | Skips pure submodule-pointer changes; support `-Force` to overwrite existing changelogs. |
| `scripts/docs/New-PackageReadmes.ps1` | Generates README + Mermaid ER snippets per package from schema maps. | `pwsh scripts/docs/New-PackageReadmes.ps1 -MapPath scripts/schema/schema-map-postgres.yaml -PackagesDir packages -OutDir docs/pkg-readmes`. | Produces badges, schema structure, columns table, ER diagram, and quick apply commands. |
| `scripts/docs/Update-UmbrellaReadme.ps1` | Updates the umbrella README badge block with package/index/FK/view counts from `PACKAGES.md`. | `pwsh scripts/docs/Update-UmbrellaReadme.ps1 -ReadmePath README.md -PackagesPath PACKAGES.md`. | Requires `<!-- AUTOBADGES:START -->` markers in README. |

## Package Management

| Script | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/packages/Audit-Packages.ps1` | Audits each submodule’s schema for PK/FK/index/time columns and produces a Markdown scorecard. | `pwsh scripts/packages/Audit-Packages.ps1 -PackagesDir packages -MapPath scripts/schema/schema-map-postgres.yaml -OutPath docs/AUDIT.md`. | Relies on `SqlDocUtils` parser; use to spot missing indexes or views. |
| `scripts/packages/Commit-SchemaPackages.ps1` | Runs `git add/commit/push` for `schema/*.sql` inside every package (optionally tagging). | `pwsh scripts/packages/Commit-SchemaPackages.ps1 -PackagesDir packages -Message "chore(schema): split" [-Tag -TagName v0.1.0-schema]`. | Ideal after running schema generators; ensures package repos stay in sync before pushing umbrella updates. |
| `scripts/packages/Push-All.ps1` | Pushes every package submodule and optionally the umbrella repo, switching to default branches automatically. | `pwsh scripts/packages/Push-All.ps1 -PackagesDir ./packages [-SkipUmbrella]`. | Fetches origin, rebases, commits using a canned message if dirty, then pushes; ensure git auth is available for each submodule. |
| `scripts/packages/Set-PackageVersion.ps1` | Writes/commits VERSION files per table (or all tables) and tags/releases packages. | `pwsh scripts/packages/Set-PackageVersion.ps1 -Table users -Version 1.3.0 -MapPath ... -PackagesDir packages -Tag -Push`. | Supports `-All` to version everything. Generates `table@v1.3.0` tags when `-Tag` is set. |
| `scripts/packages/Sync-PackageRepos.ps1` | Ensures table submodules exist (with optional GitHub repo auto-creation), removes retired modules, and syncs tags across packages. | Examples: `pwsh scripts/packages/Sync-PackageRepos.ps1 -Action ensure -CreateRemote -Table orders`; `pwsh scripts/packages/Sync-PackageRepos.ps1 -Action remove -Table legacy_table -DeleteRemote`; `pwsh scripts/packages/Sync-PackageRepos.ps1 -Action sync-tags -TagName v1.5.0 -PushTags`. | Uses the schema map to detect missing packages, bootstraps new GitHub repos via `gh` CLI, adds submodules, and can propagate or prune tags in bulk. |

## Quality & Safety

| Script / File | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/quality/Check-Secrets.ps1` | Greps the repo for common plaintext secret patterns. | `pwsh scripts/quality/Check-Secrets.ps1 -Root .` in CI or before sharing patches. | Adjust exclude list/patterns for project-specific secret names. |
| `scripts/quality/Coverage-Sql.ps1` | Checks SQL `-- region:` annotations against `.sqltrace/exec.log` to surface unexecuted regions. | Run after executing workload captured by `SqlTrace` → `pwsh scripts/quality/Coverage-Sql.ps1 -PackagesDir packages -TraceFile .sqltrace/exec.log -FailOnMiss`. | Helps track schema coverage in integration tests. |
| `scripts/quality/DQ-Checks.ps1` | Runs quick PHP data-quality probes (e.g., orphan detection) and writes JSON results. | `pwsh scripts/quality/DQ-Checks.ps1 -DbDsn "pgsql:..." -DbUser foo -DbPass bar -OutPath dq.json`. | Extend the embedded PHP snippet with more checks as needed; currently hosts an orphan orders example. |
| `scripts/quality/EmailFuzzTest.php` | PHPUnit test that inserts various tricky email cases to validate DB collation/constraints. | Run via `phpunit scripts/quality/EmailFuzzTest.php` with `DB_DSN/DB_USER/DB_PASS` env vars set. | Asserts inserts do not crash; expand the `$variants` array for regressions. |
| `scripts/quality/enforce-license.ps1` | Writes LICENSE/NOTICE/LEGAL.md into every package and the umbrella, optionally committing and pushing. | `pwsh scripts/quality/enforce-license.ps1 -Packages packages -Force -Push`. | Accepts custom license templates; ensure git is clean before pushing. |
| `scripts/quality/Explain-Snapshots.ps1` | Captures or checks SQL EXPLAIN plans listed in a JSON manifest. | `pwsh scripts/quality/Explain-Snapshots.ps1 -ManifestPath scripts/quality/explain.json -OutDir docs/plans [-Check]`. | `-Check` compares against existing snapshots and fails CI on plan drift. |
| `scripts/quality/SqlLint-Diff.sh` & `scripts/quality/sqlfluff-baseline.txt` | Runs `sqlfluff` on changed SQL files and fails on violations not listed in the baseline file. | `bash scripts/quality/SqlLint-Diff.sh` (installs sqlfluff 3.0.7). | Update `sqlfluff-baseline.txt` only when intentionally accepting legacy violations. |
| `scripts/quality/Test-PackagesSchema.ps1` | Validates each package schema folder has expected `001/020/030` files and that non-empty files stay non-empty. | `pwsh scripts/quality/Test-PackagesSchema.ps1 -PackagesDir packages`. | Fails with a summary of missing / empty files. |
| `scripts/quality/Test-SchemaOutput.ps1` | Ensures umbrella schema outputs (`001_table.sql`, etc.) cover all tables/indexes/fks from the map. | `pwsh scripts/quality/Test-SchemaOutput.ps1 -MapPath scripts/schema/schema-map-postgres.yaml -SchemaDir scripts/schema`. | Reads `schema-map.yaml`; rerun after generator changes. |

## Schema Tools

| Script / File | Purpose | When / How to Run | Notes |
| --- | --- | --- | --- |
| `scripts/schema-tools/Build-Definitions.ps1` | Generates `docs/definitions.md` per package from schema map + SQL files. | `pwsh scripts/schema-tools/Build-Definitions.ps1 -PackagesDir packages -MapPath scripts/schema/schema-map-postgres.yaml`. | Depends on `SqlDocUtils` parsers; rerun whenever SQL definitions change. |
| `scripts/schema-tools/Check-SchemaDrift.ps1` | Compares generated schema vs live DB metadata (env `DB_DSN/USER/PASS`). | `pwsh scripts/schema-tools/Check-SchemaDrift.ps1 -PackagesDir packages -MapPath scripts/schema/schema-map-postgres.yaml`. | Lists missing tables/columns; fails on drift to guard releases. |
| `scripts/schema-tools/Cleanup-SchemaFolders.ps1` | Removes legacy `src`/schema directories inside packages and optionally commits/pushes the deletions. | `pwsh scripts/schema-tools/Cleanup-SchemaFolders.ps1 -PackagesDir packages [-Only pkg1,pkg2] [-CommitPush]`. | Use before switching entirely to generated schema packages. |
| `scripts/schema-tools/Generate-MermaidERD.ps1` | Creates a Mermaid ER diagram covering every mapped table plus FK edges. | `pwsh scripts/schema-tools/Generate-MermaidERD.ps1 -PackagesDir packages -MapPath ... -OutPath docs/ERD.md`. | Output is fenced in ```mermaid blocks for quick inclusion into docs. |
| `scripts/schema-tools/Generate-PhpFromSchema.ps1` | Main PHP scaffold generator: emits DTOs, repositories, services, joins, etc. from schema maps. | `pwsh scripts/schema-tools/Generate-PhpFromSchema.ps1 -TemplatesRoot scripts/templates/php -ModulesRoot packages -MapPath ... -ViewsDir scripts/schema -TreatWarningsAsErrors`. | Huge set of switches for join policy, view drift, autowiring; see inline parameter help. |
| `scripts/schema-tools/Generate-Roles.ps1` | Emits GRANT statements (Postgres + MySQL) for app_reader/app_writer roles per table. | `pwsh scripts/schema-tools/Generate-Roles.ps1 -MapPath scripts/schema/schema-map-postgres.yaml -OutPath docs/roles.sql`. | Edit the template as needed for custom role names/passwords. |
| `scripts/schema-tools/Generate-SchemaExplorer.ps1` | Copies per-package `docs/definitions.md` into a single explorer folder plus index. | `pwsh scripts/schema-tools/Generate-SchemaExplorer.ps1 -PackagesDir packages -OutDir docs/schema-explorer`. | Useful for hosting static schema docs (e.g., GitHub Pages). |
| `scripts/schema-tools/Lint-Sql.ps1` | Enforces schema lint rules (PK required, FK indexed, view directives, timestamps). | `pwsh scripts/schema-tools/Lint-Sql.ps1 -PackagesDir packages -MapPath ... [-RulesPath scripts/schema-tools/SqlLintRules.yaml]`. | Non-zero exit on FAIL items; WARN entries are informational. |
| `scripts/schema-tools/Migrate-DryRun.ps1` | Applies SQL files inside a single transaction against `DB_DSN` and rolls back (safe dry-run). | `pwsh scripts/schema-tools/Migrate-DryRun.ps1 -SqlPaths schema/patches/*.sql -LockTimeoutMs 2000`. | Flags risky tokens (DROP/TRUNCATE) before running; aborts on any PDO error. |
| `scripts/schema-tools/mk-schema.ps1` | Builds umbrella SQL bundles (`001_table.*.sql`, etc.) from `schema-map-*.yaml`. | `pwsh scripts/schema-tools/mk-schema.ps1 -InDir scripts/schema -OutDir build/schema -Engine mysql,postgres`. | Handles tables, indexes, FKs, seed data; pass `-Force` to overwrite existing files. |
| `scripts/schema-tools/MySQL-IndexCandidates.ps1` | Parses MySQL slow logs to suggest potential indexes based on WHERE clauses. | `pwsh scripts/schema-tools/MySQL-IndexCandidates.ps1 -SlowLogPath mysql-slow.log`. | Emits “Table foo: consider index on (col1,col2)” lines. |
| `scripts/schema-tools/Split-SchemaToPackages.ps1` | Splits umbrella schema maps into per-package SQL files and pushes to submodules. | `pwsh scripts/schema-tools/Split-SchemaToPackages.ps1 -InDir scripts/schema -PackagesDir packages -Engine mysql,postgres -CommitPush`. | Supports legacy name detection, view emission, strict submodule checks. |
| `scripts/schema-tools/SqlLintRules.yaml` | Default rule set consumed by `Lint-Sql.ps1`. | Edit values (RequirePrimaryKey, RequireFkIndex, TimeColumns, etc.) to customize lint policy. | Keep this file in sync with teams’ expectations before running lint jobs. |

## Tooling Config & Support Modules

- `scripts/sqlfluff`: Shared `[sqlfluff]` config (dialect, templater, rules). `SqlLint-Diff.sh` installs the matching `sqlfluff==3.0.7`, so keep the config compatible with that release.
- `scripts/support/SqlDocUtils.psm1`: PowerShell module consumed by schema/doc scripts for parsing SQL, normalizing statements, and enumerating files.
- `scripts/support/Backoff.php`: Small PHP helper that retries arbitrary callables with exponential backoff. Include it from repositories that need resilient DB calls or API retries.
- `scripts/support/FeatureFlags.php`: PDO-backed feature-flag cache (read-through with TTL, writes via UPSERT). Wire it into services that need cheap runtime toggles.
- `scripts/support/SqlTrace.php`: Helper for emitting `region=...` logs consumed by `Coverage-Sql.ps1`. Include it in the DB abstraction layer to automatically track region coverage.
