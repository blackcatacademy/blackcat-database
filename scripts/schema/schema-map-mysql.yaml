Tables:
  payment_gateway_notifications:
    DefaultOrder: received_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS payment_gateway_notifications (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        transaction_id VARCHAR(255) NOT NULL,
        tenant_id BIGINT UNSIGNED NOT NULL,
        received_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        processing_by VARCHAR(100) NULL,
        processing_until DATETIME(6) NULL,
        attempts INT UNSIGNED NOT NULL DEFAULT 0,
        last_error VARCHAR(255) NULL,
        status ENUM('pending','processing','done','failed') NOT NULL DEFAULT 'pending',
        UNIQUE KEY ux_pg_notify_tenant_tx (tenant_id, transaction_id),
        INDEX idx_pg_notify_status_received (status, received_at),
        INDEX idx_pg_notify_tenant_status_received (tenant_id, status, received_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE payment_gateway_notifications ADD CONSTRAINT fk_pg_notify_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE payment_gateway_notifications ADD CONSTRAINT fk_pg_notify_payment FOREIGN KEY (tenant_id, transaction_id) REFERENCES payments(tenant_id, transaction_id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - received_at
        - processing_by
        - processing_until
        - attempts
        - last_error
        - status
      Keys:
        - tenant_id
        - transaction_id
  schema_registry:
    DefaultOrder: applied_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS schema_registry (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        system_name VARCHAR(120) NOT NULL,
        component VARCHAR(120) NOT NULL,
        version VARCHAR(64) NOT NULL,
        checksum VARCHAR(64) NULL,
        applied_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        meta JSON NULL,
        UNIQUE KEY uq_schema_version (system_name, component, version),
        INDEX idx_schema_component (system_name, component)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - checksum
        - applied_at
        - meta
      Keys:
        - system_name
        - component
        - version
  kms_routing_policies:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS kms_routing_policies (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(120) NOT NULL,
        priority INT NOT NULL DEFAULT 0,
        strategy ENUM('prefer','require','avoid') NOT NULL DEFAULT 'prefer',
        `match` JSON NULL,
        providers JSON NOT NULL,
        active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        CONSTRAINT uq_kms_route_name UNIQUE (name),
        INDEX idx_kms_route_active (active, priority DESC)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - priority
        - strategy
        - match
        - providers
        - active
      Keys:
        - name
  users:
    create: |-
      CREATE TABLE IF NOT EXISTS users (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        email_hash BINARY(32) NULL,
        email_hash_key_version VARCHAR(64) NULL,
        password_hash VARCHAR(255) NOT NULL,
        password_algo VARCHAR(64) NULL,
        password_key_version VARCHAR(64) NULL,
        is_active BOOLEAN NOT NULL DEFAULT 0,
        is_locked BOOLEAN NOT NULL DEFAULT 0,
        failed_logins INT NOT NULL DEFAULT 0,
        must_change_password BOOLEAN NOT NULL DEFAULT 0,
        last_login_at DATETIME(6) NULL,
        last_login_ip_hash BINARY(32) NULL,
        last_login_ip_key_version VARCHAR(64) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        deleted_at DATETIME(6) NULL,
        actor_role ENUM('customer','admin') NOT NULL DEFAULT 'customer',
        INDEX idx_users_last_login_at (last_login_at),
        INDEX idx_users_is_active (is_active),
        INDEX idx_users_actor_role (actor_role),
        INDEX idx_users_last_login_ip_hash (last_login_ip_hash)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - email_hash_key_version
        - password_hash
        - password_algo
        - password_key_version
        - is_active
        - is_locked
        - failed_logins
        - must_change_password
        - last_login_at
        - last_login_ip_hash
        - last_login_ip_key_version
        - actor_role
        - deleted_at
      Keys:
        - email_hash
    indexes:
      - CREATE UNIQUE INDEX ux_users_email_hash_live ON users (email_hash)
    SoftDelete: deleted_at
    foreign_keys:
  sync_errors:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS sync_errors (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        source VARCHAR(100) NOT NULL,
        event_key CHAR(36) NULL,
        peer_id BIGINT UNSIGNED NULL,
        error TEXT NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_sync_errors_peer    (peer_id),
        INDEX idx_sync_errors_created (created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE sync_errors ADD CONSTRAINT fk_sync_err_peer FOREIGN KEY (peer_id) REFERENCES peer_nodes(id) ON DELETE SET NULL
    indexes:
  encrypted_fields:
    create: |-
      CREATE TABLE IF NOT EXISTS encrypted_fields (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NOT NULL,
        ciphertext LONGBLOB NOT NULL,
        meta JSON NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY ux_enc_entity_field (entity_table, entity_pk, field_name),
        INDEX idx_enc_entity (entity_table, entity_pk)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - ciphertext
        - meta
        - updated_at
      Keys:
        - entity_table
        - entity_pk
        - field_name
    indexes:
      - CREATE INDEX idx_encrypted_fields_field ON encrypted_fields (field_name)
    foreign_keys:
  merkle_anchors:
    DefaultOrder: anchored_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS merkle_anchors (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        merkle_root_id BIGINT UNSIGNED NOT NULL,
        anchor_type ENUM('file','blockchain','notary') NOT NULL,
        anchor_ref VARCHAR(512) NOT NULL,
        anchored_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        meta JSON NULL,
        UNIQUE KEY ux_anchor_triplet (merkle_root_id, anchor_type, anchor_ref),
        INDEX idx_merkle_anchors_mrid (merkle_root_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE merkle_anchors ADD CONSTRAINT fk_merkle_anchor_root FOREIGN KEY (merkle_root_id) REFERENCES merkle_roots(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - anchored_at
        - meta
      Keys:
        - merkle_root_id
        - anchor_type
        - anchor_ref
  user_identities:
    create: |-
      CREATE TABLE IF NOT EXISTS user_identities (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NOT NULL,
        provider VARCHAR(100) NOT NULL,
        provider_user_id VARCHAR(255) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY ux_provider_user (provider, provider_user_id),
        INDEX idx_user_identities_user (user_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - user_id
      Keys:
        - provider
        - provider_user_id
    indexes:
    foreign_keys:
      - ALTER TABLE user_identities ADD CONSTRAINT fk_user_identities_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  tenant_domains:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS tenant_domains (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        domain VARCHAR(255) NOT NULL,
        domain_ci VARCHAR(255) GENERATED ALWAYS AS (LOWER(domain)) STORED,
        is_primary BOOLEAN NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        CONSTRAINT uq_tenant_domains UNIQUE (tenant_id, domain_ci)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE tenant_domains ADD CONSTRAINT fk_tenant_domains_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_tenant_domains_tenant ON tenant_domains (tenant_id)
  replication_lag_samples:
    DefaultOrder: captured_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS replication_lag_samples (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        peer_id BIGINT UNSIGNED NOT NULL,
        metric ENUM('apply_lag_ms','transport_lag_ms') NOT NULL,
        value BIGINT NOT NULL,
        captured_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_lag_peer_time (peer_id, captured_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE replication_lag_samples ADD CONSTRAINT fk_lag_peer FOREIGN KEY (peer_id) REFERENCES peer_nodes(id) ON DELETE CASCADE
    indexes:
  signing_keys:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS signing_keys (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        algo_id BIGINT UNSIGNED NOT NULL,
        name VARCHAR(120) NOT NULL,
        public_key LONGBLOB NOT NULL,
        private_key_enc LONGBLOB NULL,
        kms_key_id BIGINT UNSIGNED NULL,
        origin ENUM('local','kms','imported') NOT NULL DEFAULT 'local',
        status ENUM('active','retired','compromised') NOT NULL DEFAULT 'active',
        scope VARCHAR(120) NULL,
        created_by BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        activated_at DATETIME(6) NULL,
        retired_at DATETIME(6) NULL,
        notes TEXT NULL,
        UNIQUE KEY uq_signing_keys_name (name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE signing_keys ADD CONSTRAINT fk_sk_algo FOREIGN KEY (algo_id) REFERENCES crypto_algorithms(id) ON DELETE RESTRICT
      - ALTER TABLE signing_keys ADD CONSTRAINT fk_sk_kms FOREIGN KEY (kms_key_id) REFERENCES kms_keys(id) ON DELETE SET NULL
      - ALTER TABLE signing_keys ADD CONSTRAINT fk_sk_user FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_sk_algo_status ON signing_keys (algo_id, status)
    Upsert:
      Update:
        - algo_id
        - public_key
        - private_key_enc
        - kms_key_id
        - origin
        - status
        - scope
        - activated_at
        - retired_at
        - notes
      Keys:
        - name
  privacy_requests:
    DefaultOrder: requested_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS privacy_requests (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NULL,
        `type` ENUM('access','erasure','rectify','restrict','portability') NOT NULL,
        status ENUM('pending','processing','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        requested_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        processed_at DATETIME(6) NULL,
        meta JSON NULL,
        INDEX idx_pr_user        (user_id),
        INDEX idx_pr_type_status (`type`, status)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE privacy_requests ADD CONSTRAINT fk_pr_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
    Upsert:
      Update:
        - status
        - processed_at
        - meta
      Keys:
        - id
  rbac_user_roles:
    DefaultOrder: granted_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_user_roles (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NOT NULL,
        role_id BIGINT UNSIGNED NOT NULL,
        tenant_id BIGINT UNSIGNED NULL,
        scope VARCHAR(120) NULL,
        status ENUM('active','revoked','expired') NOT NULL DEFAULT 'active',
        granted_by BIGINT UNSIGNED NULL,
        granted_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        expires_at DATETIME(6) NULL,
        UNIQUE KEY uq_rbac_user_roles (user_id, role_id, tenant_id, scope)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_user_roles ADD CONSTRAINT fk_rbac_ur_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
      - ALTER TABLE rbac_user_roles ADD CONSTRAINT fk_rbac_ur_role FOREIGN KEY (role_id) REFERENCES rbac_roles(id) ON DELETE CASCADE
      - ALTER TABLE rbac_user_roles ADD CONSTRAINT fk_rbac_ur_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
      - ALTER TABLE rbac_user_roles ADD CONSTRAINT fk_rbac_ur_grant FOREIGN KEY (granted_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_rbac_user_roles_user ON rbac_user_roles (user_id)
      - CREATE INDEX idx_rbac_user_roles_role ON rbac_user_roles (role_id)
      - CREATE INDEX idx_rbac_user_roles_tenant ON rbac_user_roles (tenant_id)
    Upsert:
      Update:
        - status
        - granted_by
        - granted_at
        - expires_at
      Keys:
        - user_id
        - role_id
        - tenant_id
        - scope
  kms_keys:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS kms_keys (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        provider_id BIGINT UNSIGNED NOT NULL,
        external_key_ref VARCHAR(512) NOT NULL,
        purpose ENUM('wrap','encrypt','both') NOT NULL DEFAULT 'wrap',
        algorithm VARCHAR(64) NULL,
        status ENUM('active','retired','disabled') NOT NULL DEFAULT 'active',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE kms_keys ADD CONSTRAINT fk_kms_keys_provider FOREIGN KEY (provider_id) REFERENCES kms_providers(id) ON DELETE CASCADE
    indexes:
      - CREATE UNIQUE INDEX ux_kms_keys_provider_ref ON kms_keys (provider_id, external_key_ref)
    Upsert:
      Update:
        - purpose
        - algorithm
        - status
      Keys:
        - provider_id
        - external_key_ref
  audit_chain:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS audit_chain (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        audit_id BIGINT UNSIGNED NOT NULL,
        chain_name VARCHAR(100) NOT NULL DEFAULT 'default',
        prev_hash VARBINARY(255) NULL,
        hash VARBINARY(255) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_audit_chain (audit_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE audit_chain ADD CONSTRAINT fk_audit_chain_audit FOREIGN KEY (audit_id) REFERENCES audit_log(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_audit_chain_name_time ON audit_chain (chain_name, created_at)
    Upsert:
      Update:
        - chain_name
        - prev_hash
        - hash
      Keys:
        - audit_id
  crypto_keys:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS crypto_keys (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        basename VARCHAR(100) NOT NULL,
        version INT NOT NULL,
        filename VARCHAR(255) NULL,
        file_path VARCHAR(1024) NULL,
        fingerprint CHAR(64) NULL,
        key_meta JSON NULL,
        key_type ENUM('dek','kek','hmac','pepper') NULL,
        algorithm VARCHAR(64) NULL,
        length_bits SMALLINT NULL,
        origin ENUM('local','kms','imported') NULL,
        `usage` SET('encrypt','decrypt','sign','verify','wrap','unwrap') NULL,
        scope VARCHAR(100) NULL,
        status ENUM('active','retired','compromised','archived') NOT NULL DEFAULT 'active',
        is_backup_encrypted BOOLEAN NOT NULL DEFAULT 0,
        backup_blob LONGBLOB NULL,
        created_by BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        activated_at DATETIME(6) NULL,
        retired_at DATETIME(6) NULL,
        replaced_by BIGINT UNSIGNED NULL,
        notes TEXT NULL,
        CONSTRAINT uq_keys_basename_version UNIQUE (basename, version)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE crypto_keys ADD CONSTRAINT fk_keys_created_by FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE crypto_keys ADD CONSTRAINT fk_keys_replaced_by FOREIGN KEY (replaced_by) REFERENCES crypto_keys(id) ON DELETE SET NULL
    indexes:
    Upsert:
      Update:
        - filename
        - file_path
        - fingerprint
        - key_meta
        - key_type
        - algorithm
        - length_bits
        - origin
        - usage
        - scope
        - status
        - is_backup_encrypted
        - backup_blob
        - created_by
        - activated_at
        - retired_at
        - replaced_by
        - notes
      Keys:
        - basename
        - version
  event_outbox:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS event_outbox (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        event_key CHAR(36) NOT NULL,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        event_type VARCHAR(100) NOT NULL,
        payload JSON NOT NULL,
        status ENUM('pending','sent','failed') NOT NULL DEFAULT 'pending',
        attempts INT UNSIGNED NOT NULL DEFAULT 0,
        next_attempt_at DATETIME(6) NULL,
        processed_at DATETIME(6) NULL,
        producer_node VARCHAR(100) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_event_outbox_key (event_key)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_event_outbox_status_sched ON event_outbox (status, next_attempt_at)
      - CREATE INDEX idx_event_outbox_entity_time ON event_outbox (entity_table, entity_pk, created_at)
      - CREATE INDEX idx_event_outbox_created_at ON event_outbox (created_at)
    Upsert:
      Update:
        - payload
        - status
        - attempts
        - next_attempt_at
        - processed_at
        - producer_node
      Keys:
        - event_key
  notifications:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS notifications (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        channel ENUM('email','push') NOT NULL,
        template VARCHAR(100) NOT NULL,
        payload JSON NULL,
        status ENUM('pending','processing','sent','failed') NOT NULL DEFAULT 'pending',
        retries INT NOT NULL DEFAULT 0,
        max_retries INT NOT NULL DEFAULT 6,
        next_attempt_at DATETIME(6) NULL,
        scheduled_at DATETIME(6) NULL,
        sent_at DATETIME(6) NULL,
        error TEXT NULL,
        last_attempt_at DATETIME(6) NULL,
        locked_until DATETIME(6) NULL,
        locked_by VARCHAR(100) NULL,
        priority INT NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        INDEX idx_notifications_status_scheduled (status, scheduled_at),
        INDEX idx_notifications_tenant_status_sched (tenant_id, status, scheduled_at),
        INDEX idx_notifications_next_attempt (next_attempt_at),
        INDEX idx_notifications_locked_until (locked_until)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE notifications ADD CONSTRAINT fk_notifications_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
      - ALTER TABLE notifications ADD CONSTRAINT fk_notifications_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE notifications ADD CONSTRAINT chk_notifications_retries CHECK (retries >= 0 AND max_retries >= 0)
    indexes:
  retention_enforcement_jobs:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS retention_enforcement_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        policy_id BIGINT UNSIGNED NOT NULL,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        status ENUM('pending','running','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        processed_count BIGINT UNSIGNED NOT NULL DEFAULT 0,
        error TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_rej_status_sched (status, scheduled_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE retention_enforcement_jobs ADD CONSTRAINT fk_rej_policy FOREIGN KEY (policy_id) REFERENCES data_retention_policies(id) ON DELETE CASCADE
    indexes:
  signatures:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS signatures (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        subject_table VARCHAR(64) NOT NULL,
        subject_pk VARCHAR(64) NOT NULL,
        `context` VARCHAR(64) NOT NULL,
        algo_id BIGINT UNSIGNED NOT NULL,
        signing_key_id BIGINT UNSIGNED NULL,
        signature LONGBLOB NOT NULL,
        payload_hash VARBINARY(64) NOT NULL,
        hash_algo_id BIGINT UNSIGNED NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_signatures (subject_table, subject_pk, `context`, algo_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE signatures ADD CONSTRAINT fk_sigs_algo FOREIGN KEY (algo_id) REFERENCES crypto_algorithms(id) ON DELETE RESTRICT
      - ALTER TABLE signatures ADD CONSTRAINT fk_sigs_hash FOREIGN KEY (hash_algo_id) REFERENCES crypto_algorithms(id) ON DELETE RESTRICT
      - ALTER TABLE signatures ADD CONSTRAINT fk_sigs_skey FOREIGN KEY (signing_key_id) REFERENCES signing_keys(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_sigs_subject ON signatures (subject_table, subject_pk, `context`, created_at)
  vat_validations:
    create: |-
      CREATE TABLE IF NOT EXISTS vat_validations (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        vat_id VARCHAR(50) NOT NULL,
        country_iso2 CHAR(2) NOT NULL,
        valid BOOLEAN NOT NULL,
        checked_at DATETIME(6) NOT NULL,
        raw JSON NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE vat_validations ADD CONSTRAINT fk_vat_validations_country FOREIGN KEY (country_iso2) REFERENCES countries(iso2) ON DELETE CASCADE
    indexes:
  kms_providers:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS kms_providers (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        provider ENUM('gcp','aws','azure','vault') NOT NULL,
        location VARCHAR(100) NULL,
        project_tenant VARCHAR(150) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        is_enabled BOOLEAN NOT NULL DEFAULT TRUE
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE UNIQUE INDEX ux_kms_providers_name ON kms_providers (name)
    Upsert:
      Update:
        - provider
        - location
        - project_tenant
        - is_enabled
      Keys:
        - name
  api_keys:
    UpdatedAt: updated_at
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS api_keys (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        name VARCHAR(120) NOT NULL,
        name_ci VARCHAR(120) GENERATED ALWAYS AS (LOWER(name)) STORED,
        token_hash BINARY(32) NOT NULL,
        token_hash_key_version VARCHAR(64) NOT NULL,
        scopes JSON NOT NULL,
        status ENUM('active','revoked','disabled') NOT NULL DEFAULT 'active',
        last_used_at DATETIME(6) NULL,
        expires_at DATETIME(6) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NULL,
        CONSTRAINT uq_api_keys_token UNIQUE (token_hash),
        INDEX idx_api_keys_tenant (tenant_id),
        INDEX idx_api_keys_user   (user_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE api_keys ADD CONSTRAINT fk_api_keys_user   FOREIGN KEY (user_id)   REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE api_keys ADD CONSTRAINT fk_api_keys_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
    indexes:
      - CREATE UNIQUE INDEX ux_api_keys_tenant_name ON api_keys (tenant_id, name_ci)
  key_rotation_jobs:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS key_rotation_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        basename VARCHAR(100) NOT NULL,
        target_version INT NULL,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        status ENUM('pending','running','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        attempts INT NOT NULL DEFAULT 0,
        executed_by BIGINT UNSIGNED NULL,
        result TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_key_rotation_jobs_basename_sched (basename, scheduled_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE key_rotation_jobs ADD CONSTRAINT fk_key_rotation_jobs_user FOREIGN KEY (executed_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  carts:
    create: |-
      CREATE TABLE IF NOT EXISTS carts (
        id CHAR(36) PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        note VARCHAR(200) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: created_at DESC
    Upsert:
      Update:
        - user_id
        - note
        - updated_at
        - version
      Keys:
        - id
    indexes:
      - CREATE UNIQUE INDEX ux_carts_tenant_id ON carts (tenant_id, id)
      - CREATE INDEX idx_carts_tenant ON carts (tenant_id)
    foreign_keys:
      - ALTER TABLE carts ADD CONSTRAINT fk_carts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE carts ADD CONSTRAINT fk_carts_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
  user_profiles:
    create: |-
      CREATE TABLE IF NOT EXISTS user_profiles (
        user_id BIGINT UNSIGNED PRIMARY KEY,
        profile_enc LONGBLOB NULL,
        key_version VARCHAR(64) NULL,
        encryption_meta JSON NULL,
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: user_id DESC
    Upsert:
      Update:
        - profile_enc
        - key_version
        - encryption_meta
      Keys:
        - user_id
    indexes:
    foreign_keys:
      - ALTER TABLE user_profiles ADD CONSTRAINT fk_user_profiles_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  payments:
    create: |-
      CREATE TABLE IF NOT EXISTS payments (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NULL,
        gateway VARCHAR(100) NOT NULL,
        transaction_id VARCHAR(255) NULL,
        provider_event_id VARCHAR(255) NULL,
        status ENUM('initiated','pending','authorized','paid','cancelled','partially_refunded','refunded','failed') NOT NULL,
        amount DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        details JSON NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        UNIQUE KEY ux_payments_tenant_tx (tenant_id, transaction_id),
        UNIQUE KEY ux_payments_tenant_id (tenant_id, id),
        INDEX idx_payments_tenant (tenant_id),
        INDEX idx_payments_tenant_order (tenant_id, order_id),
        INDEX idx_payments_order (order_id),
        INDEX idx_payments_provider_event (provider_event_id),
        CONSTRAINT chk_payments_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        CONSTRAINT chk_payments_version CHECK (version >= 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - order_id
        - gateway
        - provider_event_id
        - status
        - amount
        - currency
        - details
      Keys:
        - tenant_id
        - transaction_id
    indexes:
      - CREATE INDEX idx_payments_created_at ON payments (created_at)
      - CREATE INDEX idx_payments_order_created ON payments (order_id, created_at)
    foreign_keys:
      - ALTER TABLE payments ADD CONSTRAINT fk_payments_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE payments ADD CONSTRAINT fk_payments_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE payments ADD CONSTRAINT chk_payments_amount CHECK (amount >= 0)
  rate_limit_counters:
    create: |-
      CREATE TABLE IF NOT EXISTS rate_limit_counters (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        subject_type ENUM('ip','user','api_key','tenant') NOT NULL,
        subject_id VARCHAR(128) NOT NULL,
        name VARCHAR(120) NOT NULL,
        window_start DATETIME(6) NOT NULL,
        window_size_sec INT NOT NULL,
        `count` INT NOT NULL DEFAULT 0,
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_rlc (subject_type, subject_id, name, window_start, window_size_sec),
        INDEX idx_rlc_window  (name, window_start),
        INDEX idx_rlc_subject (subject_type, subject_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: window_start DESC
    Upsert:
      Update:
        - count
        - updated_at
      Keys:
        - subject_type
        - subject_id
        - name
        - window_start
        - window_size_sec
    indexes:
    foreign_keys:
  order_item_downloads:
    create: |-
      CREATE TABLE IF NOT EXISTS order_item_downloads (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NOT NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        asset_id BIGINT UNSIGNED NOT NULL,
        download_token_hash BINARY(32) NULL,
        token_key_version VARCHAR(64) NULL,
        key_version VARCHAR(64) NULL,
        max_uses INT NOT NULL,
        used INT NOT NULL DEFAULT 0,
        is_active TINYINT(1) GENERATED ALWAYS AS (used < max_uses) STORED,
        expires_at DATETIME(6) NOT NULL,
        last_used_at DATETIME(6) NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        INDEX idx_oid_download_token_hash (download_token_hash),
        INDEX idx_oid_expires_at (expires_at),
        INDEX idx_oid_tenant_order (tenant_id, order_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE order_item_downloads ADD CONSTRAINT fk_oid_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE order_item_downloads ADD CONSTRAINT fk_oid_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE order_item_downloads ADD CONSTRAINT fk_oid_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE order_item_downloads ADD CONSTRAINT fk_oid_asset FOREIGN KEY (tenant_id, asset_id) REFERENCES book_assets(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE order_item_downloads ADD CONSTRAINT chk_oid_uses CHECK (max_uses > 0 AND used >= 0 AND used <= max_uses)
    indexes:
      - CREATE UNIQUE INDEX ux_oid_tenant_triplet ON order_item_downloads (tenant_id, order_id, book_id, asset_id)
      - CREATE INDEX idx_oid_tenant_expires_active ON order_item_downloads (tenant_id, expires_at, is_active)
    Upsert:
      Update:
        - download_token_hash
        - token_key_version
        - key_version
        - max_uses
        - used
        - expires_at
        - last_used_at
        - ip_hash
        - ip_hash_key_version
      Keys:
        - tenant_id
        - order_id
        - book_id
        - asset_id
  entity_external_ids:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS entity_external_ids (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        `source` VARCHAR(100) NOT NULL,
        external_id VARCHAR(200) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_entity_external_ids (entity_table, entity_pk, `source`)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_ext_ids_source ON entity_external_ids (source)
      - CREATE INDEX idx_ext_ids_external_id ON entity_external_ids (external_id)
    Upsert:
      Update:
        - external_id
      Keys:
        - entity_table
        - entity_pk
        - source
  book_assets:
    create: |-
      CREATE TABLE IF NOT EXISTS book_assets (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        asset_type ENUM('cover','pdf','epub','mobi','sample','extra') NOT NULL,
        filename VARCHAR(255) NOT NULL,
        mime_type VARCHAR(100) NOT NULL,
        size_bytes BIGINT NOT NULL,
        storage_path TEXT NULL,
        content_hash VARCHAR(64) NULL,
        download_filename VARCHAR(255) NULL,
        is_encrypted BOOLEAN NOT NULL DEFAULT 0,
        encryption_algo VARCHAR(50) NULL,
        encryption_key_enc BLOB NULL,
        encryption_iv VARBINARY(32) NULL,
        encryption_tag VARBINARY(32) NULL,
        encryption_aad VARBINARY(255) NULL,
        encryption_meta JSON NULL,
        key_version VARCHAR(64) NULL,
        key_id BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_book_assets_book (book_id),
        INDEX idx_book_assets_type (asset_type)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE book_assets ADD CONSTRAINT fk_book_assets_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE book_assets ADD CONSTRAINT fk_book_assets_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE book_assets ADD CONSTRAINT fk_book_assets_key FOREIGN KEY (key_id) REFERENCES crypto_keys(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_book_assets_tenant ON book_assets (tenant_id)
      - CREATE UNIQUE INDEX ux_book_assets_tenant_unique ON book_assets (tenant_id, book_id, asset_type)
      - CREATE UNIQUE INDEX ux_book_assets_tenant_id ON book_assets (tenant_id, id)
    Upsert:
      Update:
        - filename
        - mime_type
        - size_bytes
        - storage_path
        - content_hash
        - download_filename
        - is_encrypted
        - encryption_algo
        - encryption_key_enc
        - encryption_iv
        - encryption_tag
        - encryption_aad
        - encryption_meta
        - key_version
        - key_id
      Keys:
        - tenant_id
        - book_id
        - asset_type
  field_hash_policies:
    DefaultOrder: effective_from DESC
    create: |-
      CREATE TABLE IF NOT EXISTS field_hash_policies (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NOT NULL,
        profile_id BIGINT UNSIGNED NOT NULL,
        effective_from DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        notes TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_fhp (entity_table, field_name, effective_from)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE field_hash_policies ADD CONSTRAINT fk_fhp_profile FOREIGN KEY (profile_id) REFERENCES hash_profiles(id) ON DELETE RESTRICT
    indexes:
      - CREATE INDEX idx_fhp_entity_field ON field_hash_policies (entity_table, field_name, effective_from)
  rate_limits:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rate_limits (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        subject_type ENUM('ip','user','api_key','tenant') NOT NULL,
        subject_id VARCHAR(128) NOT NULL,
        name VARCHAR(120) NOT NULL,
        window_size_sec INT NOT NULL,
        limit_count INT NOT NULL,
        active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_rate_limits (subject_type, subject_id, name, window_size_sec),
        INDEX idx_rate_limits_active (active)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - limit_count
        - active
      Keys:
        - subject_type
        - subject_id
        - name
        - window_size_sec
  tenants:
    create: |-
      CREATE TABLE IF NOT EXISTS tenants (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(200) NOT NULL,
        slug VARCHAR(200) NOT NULL,
        slug_ci VARCHAR(200) GENERATED ALWAYS AS (LOWER(slug)) STORED,
        status ENUM('active','suspended','deleted') NOT NULL DEFAULT 'active',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        deleted_at DATETIME(6) NULL,
        is_live TINYINT(1) GENERATED ALWAYS AS (deleted_at IS NULL) STORED,
        CONSTRAINT chk_tenants_version CHECK (version >= 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    foreign_keys:
    indexes:
      - CREATE UNIQUE INDEX ux_tenants_slug_live_ci ON tenants (slug_ci, is_live)
    SoftDelete: deleted_at
  global_id_registry:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS global_id_registry (
        gid CHAR(26) PRIMARY KEY,              -- ULID
        guid CHAR(36) NULL,                    -- UUID (text)
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_gid_entity (entity_table, entity_pk),
        INDEX idx_gid_guid  (guid),
        INDEX idx_gid_table (entity_table)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - guid
        - entity_table
        - entity_pk
      Keys:
        - gid
  books:
    create: |-
      CREATE TABLE IF NOT EXISTS books (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        title VARCHAR(255) NOT NULL,
        slug VARCHAR(255) NOT NULL,
        slug_ci VARCHAR(255) GENERATED ALWAYS AS (LOWER(slug)) STORED,
        short_description VARCHAR(512) NULL,
        full_description LONGTEXT NULL,
        price DECIMAL(12,2) NOT NULL DEFAULT 0.00,
        currency CHAR(3) NOT NULL DEFAULT 'EUR',
        author_id BIGINT UNSIGNED NOT NULL,
        main_category_id BIGINT UNSIGNED NOT NULL,
        isbn VARCHAR(32) NULL,
        language CHAR(5) NULL,
        pages INT UNSIGNED NULL,
        publisher VARCHAR(255) NULL,
        published_at DATE NULL,
        sku VARCHAR(64) NULL,
        is_active BOOLEAN NOT NULL DEFAULT 1,
        is_available BOOLEAN NOT NULL DEFAULT 1,
        stock_quantity INT UNSIGNED NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        deleted_at DATETIME(6) NULL,
        is_live TINYINT(1) GENERATED ALWAYS AS (deleted_at IS NULL) STORED,
        INDEX idx_books_author_id (author_id),
        INDEX idx_books_main_category_id (main_category_id),
        INDEX idx_books_sku (sku),
        CONSTRAINT chk_books_currency CHECK (currency REGEXP '^[A-Z]{3}$')
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - title
        - short_description
        - full_description
        - price
        - currency
        - author_id
        - main_category_id
        - isbn
        - language
        - pages
        - publisher
        - published_at
        - sku
        - is_active
        - is_available
        - stock_quantity
        - deleted_at
      Keys:
        - tenant_id
        - slug_ci
    indexes:
      - CREATE UNIQUE INDEX ux_books_tenant_slug_live_ci ON books (tenant_id, slug_ci, is_live)
      - CREATE UNIQUE INDEX ux_books_tenant_isbn ON books (tenant_id, isbn)
      - CREATE UNIQUE INDEX ux_books_tenant_id ON books (tenant_id, id)
      - CREATE INDEX idx_books_tenant_author ON books (tenant_id, author_id)
      - CREATE INDEX idx_books_tenant_category ON books (tenant_id, main_category_id)
    SoftDelete: deleted_at
    foreign_keys:
      - ALTER TABLE books ADD CONSTRAINT fk_books_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE books ADD CONSTRAINT fk_books_author FOREIGN KEY (tenant_id, author_id) REFERENCES authors(tenant_id, id) ON DELETE RESTRICT
      - ALTER TABLE books ADD CONSTRAINT fk_books_category FOREIGN KEY (tenant_id, main_category_id) REFERENCES categories(tenant_id, id) ON DELETE RESTRICT
  sessions:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS sessions (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        token_hash BINARY(32) NOT NULL,
        token_hash_key_version VARCHAR(64) NULL,
        token_fingerprint BINARY(32) NULL,
        token_issued_at DATETIME(6) NULL,
        user_id BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        last_seen_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        expires_at DATETIME(6) NULL,
        failed_decrypt_count INT UNSIGNED NOT NULL DEFAULT 0,
        last_failed_decrypt_at DATETIME(6) NULL,
        revoked BOOLEAN NOT NULL DEFAULT 0,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        user_agent VARCHAR(1024) NULL,
        session_blob LONGBLOB NULL,
        UNIQUE KEY uq_sessions_token_hash (token_hash),
        INDEX idx_sessions_user_created (user_id, created_at),
        INDEX idx_sessions_user (user_id),
        INDEX idx_sessions_expires_at (expires_at),
        INDEX idx_sessions_last_seen (last_seen_at),
        INDEX idx_sessions_token_hash_key (token_hash_key_version)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE sessions ADD CONSTRAINT fk_sessions_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_sessions_created_at ON sessions (created_at)
    Upsert:
      Update:
        - token_hash_key_version
        - token_fingerprint
        - token_issued_at
        - user_id
        - last_seen_at
        - expires_at
        - failed_decrypt_count
        - last_failed_decrypt_at
        - revoked
        - ip_hash
        - ip_hash_key_version
        - user_agent
        - session_blob
      Keys:
        - token_hash
  key_wrapper_layers:
    DefaultOrder: key_wrapper_id DESC, layer_no ASC
    create: |-
      CREATE TABLE IF NOT EXISTS key_wrapper_layers (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        key_wrapper_id BIGINT UNSIGNED NOT NULL,
        layer_no SMALLINT UNSIGNED NOT NULL,
        kms_key_id BIGINT UNSIGNED NULL,
        kem_algo_id BIGINT UNSIGNED NOT NULL,
        kem_ciphertext LONGBLOB NOT NULL,
        encap_pubkey LONGBLOB NULL,
        aad JSON NULL,
        meta JSON NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_kwl (key_wrapper_id, layer_no)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE key_wrapper_layers ADD CONSTRAINT fk_kwl_kw FOREIGN KEY (key_wrapper_id) REFERENCES key_wrappers(id) ON DELETE CASCADE
      - ALTER TABLE key_wrapper_layers ADD CONSTRAINT fk_kwl_kms FOREIGN KEY (kms_key_id) REFERENCES kms_keys(id) ON DELETE SET NULL
      - ALTER TABLE key_wrapper_layers ADD CONSTRAINT fk_kwl_algo FOREIGN KEY (kem_algo_id) REFERENCES crypto_algorithms(id) ON DELETE RESTRICT
    indexes:
      - CREATE INDEX idx_kwl_kw ON key_wrapper_layers (key_wrapper_id)
      - CREATE INDEX idx_kwl_algo ON key_wrapper_layers (kem_algo_id)
  order_items:
    create: |-
      CREATE TABLE IF NOT EXISTS order_items (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NULL,
        book_id BIGINT UNSIGNED NULL,
        product_ref INT NULL,
        title_snapshot VARCHAR(255) NOT NULL,
        sku_snapshot VARCHAR(64) NULL,
        unit_price DECIMAL(12,2) NOT NULL,
        quantity INT UNSIGNED NOT NULL,
        tax_rate DECIMAL(5,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_order_items_order_id (order_id),
        INDEX idx_order_items_book_id (book_id),
        INDEX idx_order_items_tenant_order (tenant_id, order_id),
        INDEX idx_order_items_tenant_book (tenant_id, book_id),
        CONSTRAINT chk_order_items_qty CHECK (quantity > 0),
        CONSTRAINT chk_order_items_currency CHECK (currency REGEXP '^[A-Z]{3}$')
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE order_items ADD CONSTRAINT fk_order_items_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE order_items ADD CONSTRAINT fk_order_items_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE order_items ADD CONSTRAINT fk_order_items_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE RESTRICT
      - ALTER TABLE order_items ADD CONSTRAINT chk_order_items_tax_rate CHECK (tax_rate BETWEEN 0 AND 100)
    indexes:
  payment_webhooks:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS payment_webhooks (
        id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
        payment_id BIGINT UNSIGNED NULL,
        gateway_event_id VARCHAR(255) NULL,
        payload_hash CHAR(64) NOT NULL,
        payload JSON NULL,
        from_cache BOOLEAN NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_payment_webhooks_payment (payment_id),
        INDEX idx_payment_webhooks_gw_id (gateway_event_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE payment_webhooks ADD CONSTRAINT fk_payment_webhooks_payment FOREIGN KEY (payment_id) REFERENCES payments(id) ON DELETE SET NULL
    indexes:
      - CREATE UNIQUE INDEX ux_payment_webhooks_payload ON payment_webhooks (payload_hash)
  invoices:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS invoices (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NULL,
        invoice_number VARCHAR(100) NOT NULL,
        variable_symbol VARCHAR(50) NULL,
        issue_date DATE NOT NULL,
        due_date DATE NULL,
        subtotal DECIMAL(12,2) NOT NULL,
        discount_total DECIMAL(12,2) NOT NULL,
        tax_total DECIMAL(12,2) NOT NULL,
        total DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        qr_data LONGTEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        CONSTRAINT chk_invoices_nonneg CHECK (subtotal >= 0 AND discount_total >= 0 AND tax_total >= 0 AND total >= 0),
        CONSTRAINT chk_invoices_total_eq CHECK (total = subtotal - discount_total + tax_total),
        CONSTRAINT chk_invoices_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        UNIQUE KEY ux_invoices_tenant_no (tenant_id, invoice_number),
        INDEX idx_invoices_tenant_order (tenant_id, order_id),
        UNIQUE KEY ux_invoices_tenant_id (tenant_id, id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE invoices ADD CONSTRAINT fk_invoices_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE invoices ADD CONSTRAINT fk_invoices_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE RESTRICT
    indexes:
    Upsert:
      Update:
        - order_id
        - variable_symbol
        - issue_date
        - due_date
        - subtotal
        - discount_total
        - tax_total
        - total
        - currency
        - qr_data
      Keys:
        - tenant_id
        - invoice_number
  event_dlq:
    DefaultOrder: last_failed_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS event_dlq (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        `source` VARCHAR(100) NOT NULL,
        event_key CHAR(36) NULL,
        event JSON NOT NULL,
        error TEXT NOT NULL,
        retryable BOOLEAN NOT NULL DEFAULT 0,
        attempts INT UNSIGNED NOT NULL DEFAULT 0,
        first_failed_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        last_failed_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_event_dlq_source_time ON event_dlq (source, last_failed_at)
  event_inbox:
    DefaultOrder: received_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS event_inbox (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        `source` VARCHAR(100) NOT NULL,
        event_key CHAR(36) NOT NULL,
        payload JSON NOT NULL,
        status ENUM('pending','processed','failed') NOT NULL DEFAULT 'pending',
        attempts INT UNSIGNED NOT NULL DEFAULT 0,
        last_error TEXT NULL,
        received_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        processed_at DATETIME(6) NULL,
        UNIQUE KEY uq_event_inbox_key (`source`, event_key)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_event_inbox_status_received ON event_inbox (status, received_at)
      - CREATE INDEX idx_event_inbox_processed ON event_inbox (processed_at)
    Upsert:
      Update:
        - payload
        - status
        - attempts
        - last_error
        - processed_at
      Keys:
        - source
        - event_key
  cart_items:
    create: |-
      CREATE TABLE IF NOT EXISTS cart_items (
        id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
        tenant_id BIGINT UNSIGNED NOT NULL,
        cart_id CHAR(36) NOT NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        sku VARCHAR(64) NULL,
        sku_norm VARCHAR(64) AS (COALESCE(sku, '')) STORED,
        variant JSON NULL,
        quantity INT UNSIGNED NOT NULL,
        unit_price DECIMAL(12,2) NOT NULL DEFAULT 0.00,
        price_snapshot DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        meta JSON NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        PRIMARY KEY (id),
        UNIQUE KEY ux_cart_items (tenant_id, cart_id, book_id, sku),
        INDEX idx_cart_items_cart_id (cart_id),
        CONSTRAINT chk_cart_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        CONSTRAINT chk_cart_qty CHECK (quantity > 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE cart_items ADD CONSTRAINT fk_cart_items_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE cart_items ADD CONSTRAINT fk_cart_items_cart FOREIGN KEY (tenant_id, cart_id) REFERENCES carts(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE cart_items ADD CONSTRAINT fk_cart_items_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_cart_items_cart_id ON cart_items (cart_id)
      - CREATE INDEX idx_cart_items_tenant_cart ON cart_items (tenant_id, cart_id)
      - CREATE INDEX idx_cart_items_tenant_book ON cart_items (tenant_id, book_id)
      - CREATE UNIQUE INDEX ux_cart_items_tenant_norm ON cart_items (tenant_id, cart_id, book_id, sku_norm)
  user_consents:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS user_consents (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NOT NULL,
        consent_type VARCHAR(50) NOT NULL,
        version VARCHAR(50) NOT NULL,
        granted BOOLEAN NOT NULL,
        granted_at DATETIME(6) NOT NULL,
        source VARCHAR(100) NULL,
        meta JSON NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE user_consents ADD CONSTRAINT fk_user_consents_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_user_consents_user ON user_consents (user_id)
      - CREATE UNIQUE INDEX ux_user_consents ON user_consents (user_id, consent_type, version)
    Upsert:
      Update:
        - granted
        - granted_at
        - source
        - meta
      Keys:
        - user_id
        - consent_type
        - version
  orders:
    create: |-
      CREATE TABLE IF NOT EXISTS orders (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        uuid CHAR(36) NOT NULL UNIQUE,
        uuid_bin BINARY(16) NULL,
        public_order_no VARCHAR(64) NULL,
        user_id BIGINT UNSIGNED NULL,
        status ENUM('pending','paid','failed','cancelled','refunded','completed') NOT NULL DEFAULT 'pending',
        encrypted_customer_blob LONGBLOB NULL,
        encrypted_customer_blob_key_version VARCHAR(64) NULL,
        encryption_meta JSON NULL,
        currency CHAR(3) NOT NULL,
        metadata JSON NULL,
        subtotal DECIMAL(12,2) NOT NULL DEFAULT 0,
        discount_total DECIMAL(12,2) NOT NULL DEFAULT 0,
        tax_total DECIMAL(12,2) NOT NULL DEFAULT 0,
        total DECIMAL(12,2) NOT NULL DEFAULT 0,
        payment_method VARCHAR(100) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        INDEX idx_orders_user_id (user_id),
        INDEX idx_orders_status (status),
        INDEX idx_orders_user_status (user_id, status),
        INDEX idx_orders_tenant (tenant_id),
        INDEX idx_orders_tenant_user (tenant_id, user_id),
        UNIQUE KEY ux_orders_uuid_bin (uuid_bin),
        UNIQUE KEY ux_orders_tenant_public_no (tenant_id, public_order_no),
        UNIQUE KEY ux_orders_tenant_id (tenant_id, id),
        CONSTRAINT chk_orders_nonneg CHECK (subtotal >= 0 AND discount_total >= 0 AND tax_total >= 0 AND total >= 0),
        CONSTRAINT chk_orders_total_eq CHECK (total = subtotal - discount_total + tax_total),
        CONSTRAINT chk_orders_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        CONSTRAINT chk_orders_version CHECK (version >= 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - uuid_bin
        - public_order_no
        - user_id
        - status
        - encrypted_customer_blob
        - encrypted_customer_blob_key_version
        - encryption_meta
        - currency
        - metadata
        - subtotal
        - discount_total
        - tax_total
        - total
        - payment_method
      Keys:
        - uuid
    indexes:
      - CREATE INDEX idx_orders_created_at ON orders (created_at)
      - CREATE INDEX idx_orders_user_created ON orders (user_id, created_at)
      - CREATE INDEX idx_orders_tenant_user_created ON orders (tenant_id, user_id, created_at)
    foreign_keys:
      - ALTER TABLE orders ADD CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE orders ADD CONSTRAINT fk_orders_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
  login_attempts:
    create: |-
      CREATE TABLE IF NOT EXISTS login_attempts (
        id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
        ip_hash BINARY(32) NOT NULL,
        attempted_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        success BOOLEAN NOT NULL DEFAULT 0,
        user_id BIGINT UNSIGNED NULL,
        username_hash BINARY(32) NULL,
        auth_event_id BIGINT UNSIGNED NULL,
        INDEX idx_login_ip_success_time (ip_hash, success, attempted_at),
        INDEX idx_login_attempted_at (attempted_at),
        INDEX idx_login_username_hash (username_hash),
        INDEX idx_login_auth_event (auth_event_id),
        INDEX idx_login_user_time (user_id, attempted_at),
        CONSTRAINT chk_login_success CHECK (success IN (0,1))
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE login_attempts ADD CONSTRAINT fk_login_attempts_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE login_attempts ADD CONSTRAINT fk_login_attempts_auth_event FOREIGN KEY (auth_event_id) REFERENCES auth_events(id) ON DELETE SET NULL
    indexes:
  encryption_events:
    create: |-
      CREATE TABLE IF NOT EXISTS encryption_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NOT NULL,
        op ENUM('encrypt','decrypt','rotate','rehash','unwrap','wrap') NOT NULL,
        policy_id BIGINT UNSIGNED NULL,
        local_key_version VARCHAR(64) NULL,
        layers JSON NULL,
        outcome ENUM('success','failure') NOT NULL,
        error_code VARCHAR(64) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_enc_events_entity (entity_table, entity_pk, created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
  deletion_jobs:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS deletion_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        reason TEXT NULL,
        hard_delete BOOLEAN NOT NULL DEFAULT FALSE,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        status ENUM('pending','running','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        error TEXT NULL,
        created_by BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_deletion_jobs (entity_table, entity_pk),
        INDEX idx_dj_status_sched (status, scheduled_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE deletion_jobs ADD CONSTRAINT fk_dj_user FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
    Upsert:
      Update:
        - reason
        - hard_delete
        - scheduled_at
        - started_at
        - finished_at
        - status
        - error
        - created_by
      Keys:
        - entity_table
        - entity_pk
  categories:
    create: |-
      CREATE TABLE IF NOT EXISTS categories (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        name VARCHAR(255) NOT NULL,
        slug VARCHAR(255) NOT NULL,
        slug_ci VARCHAR(255) GENERATED ALWAYS AS (LOWER(slug)) STORED,
        parent_id BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        deleted_at DATETIME(6) NULL,
        is_live TINYINT(1) GENERATED ALWAYS AS (deleted_at IS NULL) STORED,
        INDEX idx_categories_parent (parent_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - name
        - parent_id
        - updated_at
        - version
        - deleted_at
      Keys:
        - tenant_id
        - slug_ci
    indexes:
      - CREATE UNIQUE INDEX ux_categories_tenant_slug_live_ci ON categories (tenant_id, slug_ci, is_live)
      - CREATE UNIQUE INDEX ux_categories_tenant_id ON categories (tenant_id, id)
      - CREATE INDEX idx_categories_tenant_parent ON categories (tenant_id, parent_id)
      - CREATE INDEX idx_categories_name_ci ON categories (tenant_id, (LOWER(name)))
    SoftDelete: deleted_at
    foreign_keys:
      - ALTER TABLE categories ADD CONSTRAINT fk_categories_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE categories ADD CONSTRAINT fk_categories_parent FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE SET NULL
  crypto_algorithms:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS crypto_algorithms (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        class ENUM('kem','sig','hash','symmetric') NOT NULL,
        name VARCHAR(120) NOT NULL,
        variant VARCHAR(80) NULL,
        variant_norm VARCHAR(80) GENERATED ALWAYS AS (IFNULL(variant,'')) STORED,
        nist_level SMALLINT UNSIGNED NULL,
        status ENUM('active','deprecated','experimental') NOT NULL DEFAULT 'active',
        params JSON NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_crypto_algorithms (class, name, variant_norm),
        UNIQUE KEY uq_crypto_algorithms_raw (class, name, variant)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_ca_class_status ON crypto_algorithms (class, status)
    Upsert:
      Update:
        - nist_level
        - status
        - params
      Keys:
        - class
        - name
        - variant
  reviews:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS reviews (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        rating TINYINT UNSIGNED NOT NULL,
        review_text TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NULL ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_reviews_book_id (book_id),
        INDEX idx_reviews_created_at (created_at),
        CONSTRAINT chk_reviews_rating CHECK (rating BETWEEN 1 AND 5)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE reviews ADD CONSTRAINT fk_reviews_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE reviews ADD CONSTRAINT fk_reviews_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE reviews ADD CONSTRAINT fk_reviews_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE UNIQUE INDEX ux_reviews_tenant_book_user ON reviews (tenant_id, book_id, user_id)
      - CREATE INDEX idx_reviews_user_id ON reviews (tenant_id, user_id)
      - CREATE INDEX idx_reviews_tenant_book ON reviews (tenant_id, book_id)
  idempotency_keys:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS idempotency_keys (
        key_hash CHAR(64) NOT NULL PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        payment_id BIGINT UNSIGNED NULL DEFAULT NULL,
        order_id BIGINT UNSIGNED NULL DEFAULT NULL,
        gateway_payload JSON NULL,
        redirect_url VARCHAR(1024) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        ttl_seconds INT NOT NULL DEFAULT 86400,
        INDEX idx_idemp_payment (payment_id),
        INDEX idx_idemp_order (order_id),
        INDEX idx_idemp_created_at (created_at),
        INDEX idx_idemp_tenant_payment (tenant_id, payment_id),
        INDEX idx_idemp_tenant_order (tenant_id, order_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE idempotency_keys ADD CONSTRAINT fk_idemp_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE idempotency_keys ADD CONSTRAINT fk_idemp_payment FOREIGN KEY (tenant_id, payment_id) REFERENCES payments(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE idempotency_keys ADD CONSTRAINT chk_idemp_ttl CHECK (ttl_seconds > 0)
      - ALTER TABLE idempotency_keys ADD CONSTRAINT fk_idemp_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - payment_id
        - order_id
        - gateway_payload
        - redirect_url
        - ttl_seconds
      Keys:
        - key_hash
  pq_migration_jobs:
    UpdatedAt: finished_at
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS pq_migration_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        scope ENUM('hashes','wrappers','signatures') NOT NULL,
        target_policy_id BIGINT UNSIGNED NULL,
        target_algo_id BIGINT UNSIGNED NULL,
        selection JSON NULL,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        status ENUM('pending','running','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        processed_count BIGINT UNSIGNED NOT NULL DEFAULT 0,
        error TEXT NULL,
        created_by BIGINT UNSIGNED NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_pq_mig_status_sched (status, scheduled_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE pq_migration_jobs ADD CONSTRAINT fk_pq_mig_policy FOREIGN KEY (target_policy_id) REFERENCES encryption_policies(id) ON DELETE SET NULL
      - ALTER TABLE pq_migration_jobs ADD CONSTRAINT fk_pq_mig_algo FOREIGN KEY (target_algo_id) REFERENCES crypto_algorithms(id) ON DELETE SET NULL
      - ALTER TABLE pq_migration_jobs ADD CONSTRAINT fk_pq_mig_user FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  policy_kms_keys:
    DefaultOrder: policy_id DESC, kms_key_id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS policy_kms_keys (
        policy_id BIGINT UNSIGNED NOT NULL,
        kms_key_id BIGINT UNSIGNED NOT NULL,
        weight INT NOT NULL DEFAULT 1,
        priority INT NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        PRIMARY KEY (policy_id, kms_key_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE policy_kms_keys ADD CONSTRAINT fk_policy_kms_keys_policy FOREIGN KEY (policy_id) REFERENCES encryption_policies(id) ON DELETE CASCADE
      - ALTER TABLE policy_kms_keys ADD CONSTRAINT fk_policy_kms_keys_key FOREIGN KEY (kms_key_id) REFERENCES kms_keys(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - weight
        - priority
      Keys:
        - policy_id
        - kms_key_id
  sync_batches:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS sync_batches (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        channel VARCHAR(120) NOT NULL,
        producer_peer_id BIGINT UNSIGNED NOT NULL,
        consumer_peer_id BIGINT UNSIGNED NOT NULL,
        status ENUM('pending','sending','completed','failed','cancelled') NOT NULL DEFAULT 'pending',
        items_total INT NOT NULL DEFAULT 0,
        items_ok INT NOT NULL DEFAULT 0,
        items_failed INT NOT NULL DEFAULT 0,
        error TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        INDEX idx_sync_batches_status  (status),
        INDEX idx_sync_batches_created (created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE sync_batches ADD CONSTRAINT fk_sb_producer FOREIGN KEY (producer_peer_id) REFERENCES peer_nodes(id) ON DELETE RESTRICT
      - ALTER TABLE sync_batches ADD CONSTRAINT fk_sb_consumer FOREIGN KEY (consumer_peer_id) REFERENCES peer_nodes(id) ON DELETE RESTRICT
    indexes:
    Upsert:
      Update:
        - status
        - items_total
        - items_ok
        - items_failed
        - error
        - started_at
        - finished_at
      Keys:
        - id
  encryption_bindings:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS encryption_bindings (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        entity_pk VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NULL,
        field_name_norm VARCHAR(64) GENERATED ALWAYS AS (IFNULL(field_name,'')) STORED,
        key_wrapper_id BIGINT UNSIGNED NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_enc_bind (entity_table, entity_pk, field_name_norm),
        UNIQUE KEY uq_enc_bind_raw (entity_table, entity_pk, field_name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE encryption_bindings ADD CONSTRAINT fk_enc_bind_kw FOREIGN KEY (key_wrapper_id) REFERENCES key_wrappers(id) ON DELETE RESTRICT
    indexes:
      - CREATE INDEX idx_enc_bind_entity ON encryption_bindings (entity_table, entity_pk, created_at)
    Upsert:
      Update:
        - key_wrapper_id
      Keys:
        - entity_table
        - entity_pk
        - field_name
  peer_nodes:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS peer_nodes (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(120) NOT NULL,
        `type` ENUM('postgres','mysql','app','service') NOT NULL,
        location VARCHAR(120) NULL,
        status ENUM('active','offline','degraded','disabled') NOT NULL DEFAULT 'active',
        last_seen DATETIME(6) NULL,
        meta JSON NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        CONSTRAINT uq_peer_nodes_name UNIQUE (name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
      - CREATE INDEX idx_peer_nodes_status    ON peer_nodes (status)
      - CREATE INDEX idx_peer_nodes_last_seen ON peer_nodes (last_seen)
    Upsert:
      Update:
        - type
        - location
        - status
        - last_seen
        - meta
      Keys:
        - name
  rbac_user_permissions:
    DefaultOrder: granted_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_user_permissions (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NOT NULL,
        permission_id BIGINT UNSIGNED NOT NULL,
        tenant_id BIGINT UNSIGNED NULL,
        scope VARCHAR(120) NULL,
        effect ENUM('allow','deny') NOT NULL DEFAULT 'allow',
        granted_by BIGINT UNSIGNED NULL,
        granted_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        expires_at DATETIME(6) NULL,
        UNIQUE KEY uq_rbac_user_perm (user_id, permission_id, tenant_id, scope)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_user_permissions ADD CONSTRAINT fk_rbac_up_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
      - ALTER TABLE rbac_user_permissions ADD CONSTRAINT fk_rbac_up_perm FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
      - ALTER TABLE rbac_user_permissions ADD CONSTRAINT fk_rbac_up_grant FOREIGN KEY (granted_by) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE rbac_user_permissions ADD CONSTRAINT fk_rbac_up_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_rbac_up_user ON rbac_user_permissions (user_id)
      - CREATE INDEX idx_rbac_up_perm ON rbac_user_permissions (permission_id)
    Upsert:
      Update:
        - effect
        - granted_by
        - granted_at
        - expires_at
      Keys:
        - user_id
        - permission_id
        - tenant_id
        - scope
  kms_health_checks:
    DefaultOrder: checked_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS kms_health_checks (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        provider_id BIGINT UNSIGNED NULL,
        kms_key_id BIGINT UNSIGNED NULL,
        status ENUM('up','degraded','down') NOT NULL,
        latency_ms INT NULL,
        error TEXT NULL,
        checked_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE kms_health_checks ADD CONSTRAINT fk_kms_hc_provider FOREIGN KEY (provider_id) REFERENCES kms_providers(id) ON DELETE SET NULL
      - ALTER TABLE kms_health_checks ADD CONSTRAINT fk_kms_hc_key FOREIGN KEY (kms_key_id) REFERENCES kms_keys(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_kms_hc_provider_time ON kms_health_checks (provider_id, checked_at)
      - CREATE INDEX idx_kms_hc_key_time ON kms_health_checks (kms_key_id, checked_at)
  email_verifications:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS email_verifications (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NOT NULL,
        token_hash CHAR(64) NULL,
        selector CHAR(12) NOT NULL,
        validator_hash BINARY(32) NULL,
        key_version VARCHAR(64) NULL,
        expires_at DATETIME(6) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        used_at DATETIME(6) NULL,
        UNIQUE KEY ux_ev_selector (selector),
        INDEX idx_ev_user (user_id),
        INDEX idx_ev_expires (expires_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE email_verifications ADD CONSTRAINT fk_ev_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - user_id
        - token_hash
        - validator_hash
        - key_version
        - expires_at
        - created_at
        - used_at
      Keys:
        - selector
  rewrap_jobs:
    UpdatedAt: finished_at
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rewrap_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        key_wrapper_id BIGINT UNSIGNED NOT NULL,
        target_kms1_key_id BIGINT UNSIGNED NULL,
        target_kms2_key_id BIGINT UNSIGNED NULL,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        status ENUM('pending','running','done','failed') NOT NULL DEFAULT 'pending',
        attempts INT UNSIGNED NOT NULL DEFAULT 0,
        last_error TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rewrap_jobs ADD CONSTRAINT fk_rewrap_kw FOREIGN KEY (key_wrapper_id) REFERENCES key_wrappers(id) ON DELETE CASCADE
      - ALTER TABLE rewrap_jobs ADD CONSTRAINT fk_rewrap_tk1 FOREIGN KEY (target_kms1_key_id) REFERENCES kms_keys(id) ON DELETE SET NULL
      - ALTER TABLE rewrap_jobs ADD CONSTRAINT fk_rewrap_tk2 FOREIGN KEY (target_kms2_key_id) REFERENCES kms_keys(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_rewrap_status_sched ON rewrap_jobs (status, scheduled_at)
      - CREATE INDEX idx_rewrap_kw ON rewrap_jobs (key_wrapper_id)
  system_errors:
    DefaultOrder: last_seen DESC
    create: |-
      CREATE TABLE IF NOT EXISTS system_errors (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        level ENUM('notice','warning','error','critical') NOT NULL,
        message TEXT NOT NULL,
        exception_class VARCHAR(255) NULL,
        file VARCHAR(1024) NULL,
        line INT UNSIGNED NULL,
        stack_trace MEDIUMTEXT NULL,
        token VARCHAR(255) NULL,
        context JSON NULL,
        fingerprint VARCHAR(64) NULL,
        occurrences INT UNSIGNED NOT NULL DEFAULT 1,
        user_id BIGINT UNSIGNED NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        ip_text VARCHAR(45) NULL,
        ip_bin VARBINARY(16) NULL,
        user_agent VARCHAR(1024) NULL,
        url VARCHAR(2048) NULL,
        `method` VARCHAR(10) NULL,
        http_status SMALLINT UNSIGNED NULL,
        resolved BOOLEAN NOT NULL DEFAULT 0,
        resolved_by BIGINT UNSIGNED NULL,
        resolved_at DATETIME(6) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        last_seen DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_err_level (level),
        INDEX idx_err_time (created_at),
        INDEX idx_err_user (user_id),
        INDEX idx_err_ip (ip_hash),
        INDEX idx_err_resolved (resolved),
        UNIQUE KEY uq_err_fp (fingerprint)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE system_errors ADD CONSTRAINT fk_err_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE system_errors ADD CONSTRAINT fk_err_resolved_by FOREIGN KEY (resolved_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_system_errors_last_seen ON system_errors (last_seen)
    Upsert:
      Update:
        - level
        - message
        - exception_class
        - file
        - line
        - stack_trace
        - token
        - context
        - occurrences
        - user_id
        - ip_hash
        - ip_hash_key_version
        - ip_text
        - ip_bin
        - user_agent
        - url
        - method
        - http_status
        - resolved
        - resolved_by
        - resolved_at
        - last_seen
      Keys:
        - fingerprint
  rbac_role_permissions:
    DefaultOrder: role_id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_role_permissions (
        role_id BIGINT UNSIGNED NOT NULL,
        permission_id BIGINT UNSIGNED NOT NULL,
        effect ENUM('allow','deny') NOT NULL DEFAULT 'allow',
        source ENUM('repo','local') NOT NULL DEFAULT 'repo',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        PRIMARY KEY (role_id, permission_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_role_permissions ADD CONSTRAINT fk_rbac_rp_role FOREIGN KEY (role_id) REFERENCES rbac_roles(id) ON DELETE CASCADE
      - ALTER TABLE rbac_role_permissions ADD CONSTRAINT fk_rbac_rp_perm FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - effect
        - source
      Keys:
        - role_id
        - permission_id
  verify_events:
    create: |-
      CREATE TABLE IF NOT EXISTS verify_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NULL,
        `type` ENUM('verify_success','verify_failure') NOT NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        user_agent VARCHAR(1024) NULL,
        occurred_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        meta JSON NULL,
        INDEX idx_ver_user (user_id),
        INDEX idx_ver_time (occurred_at),
        INDEX idx_ver_type_time (`type`, occurred_at),
        INDEX idx_ver_ip (ip_hash)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE verify_events ADD CONSTRAINT fk_verify_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  payment_logs:
    DefaultOrder: log_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS payment_logs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        payment_id BIGINT UNSIGNED NOT NULL,
        log_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        message TEXT NOT NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE payment_logs ADD CONSTRAINT fk_payment_logs_payment FOREIGN KEY (payment_id) REFERENCES payments(id) ON DELETE CASCADE
    indexes:
  encryption_policy_bindings:
    DefaultOrder: effective_from DESC
    create: |-
      CREATE TABLE IF NOT EXISTS encryption_policy_bindings (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NOT NULL,
        policy_id BIGINT UNSIGNED NOT NULL,
        effective_from DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        notes TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_enc_policy_bind (entity_table, field_name, effective_from)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE encryption_policy_bindings ADD CONSTRAINT fk_enc_pol_bind_policy FOREIGN KEY (policy_id) REFERENCES encryption_policies(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_enc_pol_bind_entity ON encryption_policy_bindings (entity_table, field_name, effective_from)
    Upsert:
      Update:
        - policy_id
        - notes
      Keys:
        - entity_table
        - field_name
        - effective_from
  book_categories:
    DefaultOrder: tenant_id DESC, book_id DESC, category_id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS book_categories (
        tenant_id BIGINT UNSIGNED NOT NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        category_id BIGINT UNSIGNED NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        PRIMARY KEY (tenant_id, book_id, category_id),
        INDEX idx_book_categories_category (category_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE book_categories ADD CONSTRAINT fk_book_categories_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE book_categories ADD CONSTRAINT fk_book_categories_category FOREIGN KEY (tenant_id, category_id) REFERENCES categories(tenant_id, id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_book_categories_book ON book_categories (book_id)
      - CREATE INDEX idx_book_categories_tenant ON book_categories (tenant_id)
    Upsert:
      Update:
      Keys:
        - tenant_id
        - book_id
        - category_id
  key_events:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS key_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        key_id BIGINT UNSIGNED NULL,
        basename VARCHAR(100) NULL,
        event_type ENUM('created','rotated','activated','retired','compromised','deleted','used_encrypt','used_decrypt','access_failed','backup','restore') NOT NULL,
        actor_id BIGINT UNSIGNED NULL,
        job_id BIGINT UNSIGNED NULL,
        note TEXT NULL,
        meta JSON NULL,
        `source` ENUM('cron','admin','api','manual') NOT NULL DEFAULT 'admin',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_key_events_key_created (key_id, created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE key_events ADD CONSTRAINT fk_key_events_key FOREIGN KEY (key_id) REFERENCES crypto_keys(id) ON DELETE SET NULL
      - ALTER TABLE key_events ADD CONSTRAINT fk_key_events_actor FOREIGN KEY (actor_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_key_events_basename ON key_events (basename)
  slo_status:
    DefaultOrder: computed_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS slo_status (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        window_id BIGINT UNSIGNED NOT NULL,
        computed_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        sli_value DECIMAL(18,6) NULL,
        good_events BIGINT UNSIGNED NOT NULL DEFAULT 0,
        total_events BIGINT UNSIGNED NOT NULL DEFAULT 0,
        status ENUM('good','breach','unknown') NOT NULL DEFAULT 'unknown',
        UNIQUE KEY ux_slo_status (window_id, computed_at),
        INDEX idx_slo_status_window (window_id, computed_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE slo_status ADD CONSTRAINT fk_slo_status_window FOREIGN KEY (window_id) REFERENCES slo_windows(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - sli_value
        - good_events
        - total_events
        - status
      Keys:
        - window_id
        - computed_at
  permissions:
    create: |-
      CREATE TABLE IF NOT EXISTS permissions (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL UNIQUE,
        description TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - description
      Keys:
        - name
    indexes:
    foreign_keys:
  coupons:
    create: |-
      CREATE TABLE IF NOT EXISTS coupons (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        code VARCHAR(100) NOT NULL,
        code_ci VARCHAR(100) GENERATED ALWAYS AS (LOWER(code)) STORED,
        `type` ENUM('percent','fixed') NOT NULL,
        value DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NULL,
        starts_at DATE NOT NULL,
        ends_at DATE NULL,
        max_redemptions INT NOT NULL DEFAULT 0,
        min_order_amount DECIMAL(12,2) NULL,
        applies_to JSON NULL,
        is_active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        CONSTRAINT chk_coupon_percent_fixed CHECK (
          (`type`='percent' AND value BETWEEN 0 AND 100 AND currency IS NULL)
          OR (`type`='fixed' AND value >= 0 AND (currency REGEXP '^[A-Z]{3}$')))
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - type
        - value
        - currency
        - starts_at
        - ends_at
        - max_redemptions
        - min_order_amount
        - applies_to
        - is_active
        - updated_at
      Keys:
        - tenant_id
        - code_ci
    indexes:
      - CREATE UNIQUE INDEX ux_coupons_tenant_code_ci ON coupons (tenant_id, code_ci)
      - CREATE INDEX idx_coupons_tenant_active ON coupons (tenant_id, is_active)
      - CREATE UNIQUE INDEX idx_coupons_tenant_id ON coupons (tenant_id, id)
    foreign_keys:
      - ALTER TABLE coupons ADD CONSTRAINT fk_coupons_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
  migration_events:
    DefaultOrder: started_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS migration_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        system_name VARCHAR(120) NOT NULL,
        from_version VARCHAR(64) NULL,
        to_version VARCHAR(64) NOT NULL,
        status ENUM('pending','running','done','failed','cancelled') NOT NULL DEFAULT 'pending',
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        error TEXT NULL,
        meta JSON NULL,
        INDEX idx_mig_system_status (system_name, status),
        INDEX idx_mig_started       (started_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
  encryption_policies:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS encryption_policies (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        policy_name VARCHAR(100) NOT NULL UNIQUE,
        mode ENUM('local','kms','multi-kms') NOT NULL,
        layer_selection ENUM('defined','round_robin','random','hash_mod') NOT NULL DEFAULT 'defined',
        min_layers TINYINT UNSIGNED NOT NULL DEFAULT 1,
        max_layers TINYINT UNSIGNED NOT NULL DEFAULT 3,
        aad_template JSON NULL,
        notes TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - mode
        - layer_selection
        - min_layers
        - max_layers
        - aad_template
        - notes
      Keys:
        - policy_name
  rbac_repositories:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_repositories (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(120) NOT NULL,
        url VARCHAR(1024) NULL,
        signing_key_id BIGINT UNSIGNED NULL,
        status ENUM('active','disabled') NOT NULL DEFAULT 'active',
        last_synced_at DATETIME(6) NULL,
        last_commit VARCHAR(128) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_rbac_repositories_name (name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_repositories ADD CONSTRAINT fk_rbac_repos_sign_key FOREIGN KEY (signing_key_id) REFERENCES signing_keys(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_rbac_repos_status ON rbac_repositories (status)
    Upsert:
      Update:
        - url
        - signing_key_id
        - status
        - last_synced_at
        - last_commit
      Keys:
        - name
  register_events:
    create: |-
      CREATE TABLE IF NOT EXISTS register_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NULL,
        `type` ENUM('register_success','register_failure') NOT NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        user_agent VARCHAR(1024) NULL,
        occurred_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        meta JSON NULL,
        INDEX idx_reg_user (user_id),
        INDEX idx_reg_time (occurred_at),
        INDEX idx_reg_type_time (`type`, occurred_at),
        INDEX idx_reg_ip (ip_hash)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE register_events ADD CONSTRAINT fk_register_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  hash_profiles:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS hash_profiles (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(120) NOT NULL,
        algo_id BIGINT UNSIGNED NOT NULL,
        output_len SMALLINT UNSIGNED NULL,
        params JSON NULL,
        status ENUM('active','deprecated') NOT NULL DEFAULT 'active',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_hash_profiles_name (name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE hash_profiles ADD CONSTRAINT fk_hp_algo FOREIGN KEY (algo_id) REFERENCES crypto_algorithms(id) ON DELETE RESTRICT
    indexes:
      - CREATE INDEX idx_hp_algo_status ON hash_profiles (algo_id, status)
    Upsert:
      Update:
        - algo_id
        - output_len
        - params
        - status
      Keys:
        - name
  invoice_items:
    DefaultOrder: invoice_id DESC, line_no DESC
    create: |-
      CREATE TABLE IF NOT EXISTS invoice_items (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        invoice_id BIGINT UNSIGNED NOT NULL,
        line_no INT NOT NULL,
        description TEXT NOT NULL,
        unit_price DECIMAL(12,2) NOT NULL,
        quantity INT UNSIGNED NOT NULL,
        tax_rate DECIMAL(5,2) NOT NULL,
        tax_amount DECIMAL(12,2) NOT NULL,
        line_total DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_invoice_line (invoice_id, line_no),
        INDEX idx_invoice_items_tenant_invoice (tenant_id, invoice_id),
        CONSTRAINT chk_invoice_items_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        CONSTRAINT chk_invoice_items_qty CHECK (quantity > 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE invoice_items ADD CONSTRAINT fk_invoice_items_invoice FOREIGN KEY (tenant_id, invoice_id) REFERENCES invoices(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE invoice_items ADD CONSTRAINT chk_invoice_items_tax_rate CHECK (tax_rate BETWEEN 0 AND 100)
    indexes:
    Upsert:
      Update:
        - description
        - unit_price
        - quantity
        - tax_rate
        - tax_amount
        - line_total
        - currency
      Keys:
        - invoice_id
        - line_no
  refunds:
    create: |-
      CREATE TABLE IF NOT EXISTS refunds (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        payment_id BIGINT UNSIGNED NOT NULL,
        amount DECIMAL(12,2) NOT NULL,
        currency CHAR(3) NOT NULL,
        reason TEXT NULL,
        status VARCHAR(50) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        details JSON NULL,
        CONSTRAINT chk_refunds_currency CHECK (currency REGEXP '^[A-Z]{3}$'),
        INDEX idx_refunds_tenant_payment (tenant_id, payment_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE refunds ADD CONSTRAINT fk_refunds_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE refunds ADD CONSTRAINT fk_refunds_payment FOREIGN KEY (tenant_id, payment_id) REFERENCES payments(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE refunds ADD CONSTRAINT chk_refunds_amount CHECK (amount >= 0)
    indexes:
      - CREATE INDEX idx_refunds_payment ON refunds (payment_id)
  rbac_roles:
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_roles (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        repo_id BIGINT UNSIGNED NULL,
        slug VARCHAR(120) NOT NULL,
        name VARCHAR(200) NOT NULL,
        description TEXT NULL,
        version INT NOT NULL DEFAULT 1,
        status ENUM('active','deprecated','archived') NOT NULL DEFAULT 'active',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_rbac_roles_repo_slug (repo_id, slug)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - name
        - description
        - version
        - status
        - updated_at
      Keys:
        - repo_id
        - slug
    indexes:
      - CREATE INDEX idx_rbac_roles_repo ON rbac_roles (repo_id)
      - CREATE INDEX idx_rbac_roles_status ON rbac_roles (status)
    foreign_keys:
      - ALTER TABLE rbac_roles ADD CONSTRAINT fk_rbac_roles_repo FOREIGN KEY (repo_id) REFERENCES rbac_repositories(id) ON DELETE SET NULL
  authors:
    create: |-
      CREATE TABLE IF NOT EXISTS authors (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        name VARCHAR(255) NOT NULL,
        slug VARCHAR(255) NOT NULL,
        slug_ci VARCHAR(255) GENERATED ALWAYS AS (LOWER(slug)) STORED,
        bio TEXT NULL,
        photo_url VARCHAR(255) NULL,
        story LONGTEXT NULL,
        books_count INT NOT NULL DEFAULT 0,
        ratings_count INT NOT NULL DEFAULT 0,
        rating_sum INT NOT NULL DEFAULT 0,
        avg_rating DECIMAL(3,2) NULL DEFAULT NULL,
        last_rating_at DATETIME(6) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        deleted_at DATETIME(6) NULL,
        is_live TINYINT(1) GENERATED ALWAYS AS (deleted_at IS NULL) STORED,
        INDEX idx_authors_avg_rating (avg_rating),
        INDEX idx_authors_books_count (books_count)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - name
        - bio
        - photo_url
        - story
        - books_count
        - ratings_count
        - rating_sum
        - avg_rating
        - last_rating_at
        - updated_at
        - version
        - deleted_at
      Keys:
        - tenant_id
        - slug_ci
    indexes:
      - CREATE UNIQUE INDEX ux_authors_tenant_slug_live_ci ON authors (tenant_id, slug_ci, is_live)
      - CREATE UNIQUE INDEX ux_authors_tenant_id ON authors (tenant_id, id)
      - CREATE INDEX idx_authors_name_ci ON authors (tenant_id, (LOWER(name)))
    SoftDelete: deleted_at
    foreign_keys:
      - ALTER TABLE authors ADD CONSTRAINT fk_authors_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
  tax_rates:
    DefaultOrder: valid_from DESC
    create: |-
      CREATE TABLE IF NOT EXISTS tax_rates (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        country_iso2 CHAR(2) NOT NULL,
        category ENUM('ebook','physical') NOT NULL,
        rate DECIMAL(5,2) NOT NULL,
        valid_from DATE NOT NULL,
        valid_to DATE NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE tax_rates ADD CONSTRAINT fk_tax_rates_country FOREIGN KEY (country_iso2) REFERENCES countries(iso2) ON DELETE CASCADE
      - ALTER TABLE tax_rates ADD CONSTRAINT chk_tax_rates_rate CHECK (rate BETWEEN 0 AND 100)
    indexes:
      - CREATE UNIQUE INDEX ux_tax_rates_country_cat_from ON tax_rates (country_iso2, category, valid_from)
    Upsert:
      Update:
        - rate
        - valid_to
      Keys:
        - country_iso2
        - category
        - valid_from
  sync_batch_items:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS sync_batch_items (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        batch_id BIGINT UNSIGNED NOT NULL,
        event_key CHAR(36) NOT NULL,
        status ENUM('pending','sent','applied','failed','skipped') NOT NULL DEFAULT 'pending',
        error TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_sync_batch_event (batch_id, event_key),
        INDEX idx_sbi_batch  (batch_id),
        INDEX idx_sbi_status (status)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE sync_batch_items ADD CONSTRAINT fk_sbi_batch FOREIGN KEY (batch_id) REFERENCES sync_batches(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - status
        - error
      Keys:
        - batch_id
        - event_key
  worker_locks:
    create: |-
      CREATE TABLE IF NOT EXISTS worker_locks (
        name VARCHAR(191) NOT NULL PRIMARY KEY,
        locked_until DATETIME(6) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        INDEX idx_worker_locks_until (locked_until)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
  webhook_outbox:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS webhook_outbox (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        event_type VARCHAR(100) NOT NULL,
        payload JSON NULL,
        status ENUM('pending','sent','failed') NOT NULL DEFAULT 'pending',
        retries INT NOT NULL DEFAULT 0,
        next_attempt_at DATETIME(6) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        INDEX idx_webhook_status_scheduled (status, next_attempt_at),
        INDEX idx_webhook_created_at (created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
  slo_windows:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS slo_windows (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(120) NOT NULL,
        objective JSON NOT NULL,      -- {"metric":"outbox_latency_sec","threshold":10,"percentile":95}
        target_pct DECIMAL(5,2) NOT NULL,
        window_interval VARCHAR(64) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        CONSTRAINT uq_slo_windows_name UNIQUE (name)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - objective
        - target_pct
        - window_interval
      Keys:
        - name
  newsletter_subscribers:
    create: |-
      CREATE TABLE IF NOT EXISTS newsletter_subscribers (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        email_hash BINARY(32) NOT NULL,
        email_hash_key_version VARCHAR(64) NULL,
        email_enc LONGBLOB NULL,
        email_key_version VARCHAR(64) NULL,
        confirm_selector CHAR(12) DEFAULT NULL,
        confirm_validator_hash BINARY(32) DEFAULT NULL,
        confirm_key_version VARCHAR(64) DEFAULT NULL,
        confirm_expires DATETIME(6) DEFAULT NULL,
        confirmed_at DATETIME(6) DEFAULT NULL,
        unsubscribe_token_hash BINARY(32) DEFAULT NULL,
        unsubscribe_token_key_version VARCHAR(64) DEFAULT NULL,
        unsubscribed_at DATETIME(6) DEFAULT NULL,
        origin VARCHAR(100) DEFAULT NULL,
        ip_hash BINARY(32) DEFAULT NULL,
        ip_hash_key_version VARCHAR(64) DEFAULT NULL,
        meta JSON DEFAULT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        UNIQUE KEY ux_ns_tenant_email_hash (tenant_id, email_hash),
        UNIQUE KEY ux_ns_confirm_selector (confirm_selector),
        INDEX idx_ns_tenant (tenant_id),
        INDEX idx_ns_user (user_id),
        INDEX idx_ns_confirm_expires (confirm_expires),
        INDEX idx_ns_unsubscribed_at (unsubscribed_at),
        INDEX idx_ns_confirmed_at (confirmed_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: id DESC
    Upsert:
      Update:
        - user_id
        - email_hash_key_version
        - email_enc
        - email_key_version
        - confirm_selector
        - confirm_validator_hash
        - confirm_key_version
        - confirm_expires
        - confirmed_at
        - unsubscribe_token_hash
        - unsubscribe_token_key_version
        - unsubscribed_at
        - origin
        - ip_hash
        - ip_hash_key_version
        - meta
        - updated_at
        - version
      Keys:
        - tenant_id
        - email_hash
    indexes:
    foreign_keys:
      - ALTER TABLE newsletter_subscribers ADD CONSTRAINT fk_ns_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE newsletter_subscribers ADD CONSTRAINT fk_ns_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
  coupon_redemptions:
    DefaultOrder: redeemed_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS coupon_redemptions (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        coupon_id BIGINT UNSIGNED NOT NULL,
        user_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NOT NULL,
        redeemed_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        amount_applied DECIMAL(12,2) NOT NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE coupon_redemptions ADD CONSTRAINT fk_cr_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE coupon_redemptions ADD CONSTRAINT fk_cr_coupon FOREIGN KEY (tenant_id, coupon_id) REFERENCES coupons(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE coupon_redemptions ADD CONSTRAINT fk_cr_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE coupon_redemptions ADD CONSTRAINT fk_cr_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_cr_coupon ON coupon_redemptions (coupon_id)
      - CREATE INDEX idx_cr_user   ON coupon_redemptions (user_id)
      - CREATE INDEX idx_cr_order  ON coupon_redemptions (order_id)
      - CREATE INDEX idx_cr_tenant_coupon ON coupon_redemptions (tenant_id, coupon_id)
      - CREATE INDEX idx_cr_tenant_user   ON coupon_redemptions (tenant_id, user_id)
      - CREATE INDEX idx_cr_tenant_order  ON coupon_redemptions (tenant_id, order_id)
      - CREATE UNIQUE INDEX ux_cr_tenant_order_coupon ON coupon_redemptions (tenant_id, order_id, coupon_id)
  system_jobs:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS system_jobs (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        job_type VARCHAR(100) NOT NULL,
        payload JSON NULL,
        status ENUM('pending','processing','done','failed') NOT NULL DEFAULT 'pending',
        retries INT NOT NULL DEFAULT 0,
        scheduled_at DATETIME(6) NULL,
        started_at DATETIME(6) NULL,
        finished_at DATETIME(6) NULL,
        error TEXT NULL,
        unique_key_hash CHAR(64) NULL,
        unique_key_version VARCHAR(64) NULL,
        locked_until DATETIME(6) NULL,
        locked_by VARCHAR(100) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        INDEX idx_system_jobs_status_sched (status, scheduled_at),
        INDEX idx_system_jobs_locked_until (locked_until)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
  policy_algorithms:
    DefaultOrder: policy_id DESC, priority DESC
    create: |-
      CREATE TABLE IF NOT EXISTS policy_algorithms (
        policy_id BIGINT UNSIGNED NOT NULL,
        algo_id BIGINT UNSIGNED NOT NULL,
        role ENUM('kem','sig','hash','symmetric') NOT NULL,
        weight INT NOT NULL DEFAULT 1,
        priority INT NOT NULL DEFAULT 0,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        PRIMARY KEY (policy_id, algo_id, role)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE policy_algorithms ADD CONSTRAINT fk_pa_policy FOREIGN KEY (policy_id) REFERENCES encryption_policies(id) ON DELETE CASCADE
      - ALTER TABLE policy_algorithms ADD CONSTRAINT fk_pa_algo FOREIGN KEY (algo_id) REFERENCES crypto_algorithms(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - weight
        - priority
      Keys:
        - policy_id
        - algo_id
        - role
  rbac_sync_cursors:
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_sync_cursors (
        repo_id BIGINT UNSIGNED NOT NULL,
        peer VARCHAR(120) NOT NULL,
        last_commit VARCHAR(128) NULL,
        last_synced_at DATETIME(6) NULL,
        PRIMARY KEY (repo_id, peer)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_sync_cursors ADD CONSTRAINT fk_rbac_cursors_repo FOREIGN KEY (repo_id) REFERENCES rbac_repositories(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - last_commit
        - last_synced_at
      Keys:
        - repo_id
        - peer
  two_factor:
    DefaultOrder: user_id DESC, method DESC
    create: |-
      CREATE TABLE IF NOT EXISTS two_factor (
        user_id BIGINT UNSIGNED NOT NULL,
        `method` VARCHAR(50) NOT NULL,
        secret VARBINARY(255) NULL,
        recovery_codes_enc LONGBLOB NULL,
        hotp_counter BIGINT UNSIGNED NULL,
        enabled BOOLEAN NOT NULL DEFAULT FALSE,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        last_used_at DATETIME(6) NULL,
        PRIMARY KEY (user_id, `method`)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE two_factor ADD CONSTRAINT fk_two_factor_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - secret
        - recovery_codes_enc
        - hotp_counter
        - enabled
        - last_used_at
      Keys:
        - user_id
        - method
  key_wrappers:
    DefaultOrder: id DESC
    create: |-
      CREATE TABLE IF NOT EXISTS key_wrappers (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        wrapper_uuid CHAR(36) NOT NULL,
        kms1_key_id BIGINT UNSIGNED NOT NULL,
        kms2_key_id BIGINT UNSIGNED NOT NULL,
        dek_wrap1 LONGBLOB NOT NULL,
        dek_wrap2 LONGBLOB NOT NULL,
        crypto_suite JSON NULL,
        wrap_version INT NOT NULL DEFAULT 1,
        status ENUM('active','rotated','retired','invalid') NOT NULL DEFAULT 'active',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        rotated_at DATETIME(6) NULL,
        UNIQUE KEY uq_key_wrappers_uuid (wrapper_uuid)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE key_wrappers ADD CONSTRAINT fk_kw_kms1 FOREIGN KEY (kms1_key_id) REFERENCES kms_keys(id) ON DELETE RESTRICT
      - ALTER TABLE key_wrappers ADD CONSTRAINT fk_kw_kms2 FOREIGN KEY (kms2_key_id) REFERENCES kms_keys(id) ON DELETE RESTRICT
    indexes:
      - CREATE UNIQUE INDEX ux_kw_k1_k2_version ON key_wrappers (kms1_key_id, kms2_key_id, wrap_version)
      - CREATE INDEX idx_kw_status_created ON key_wrappers (status, created_at)
    Upsert:
      Update:
        - kms1_key_id
        - kms2_key_id
        - dek_wrap1
        - dek_wrap2
        - crypto_suite
        - wrap_version
        - status
        - rotated_at
      Keys:
        - wrapper_uuid
  countries:
    DefaultOrder: iso2 ASC
    create: |-
      CREATE TABLE IF NOT EXISTS countries (
        iso2 CHAR(2) PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        CONSTRAINT chk_countries_iso2 CHECK (iso2 REGEXP '^[A-Z]{2}$')
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - name
      Keys:
        - iso2
  auth_events:
    create: |-
      CREATE TABLE IF NOT EXISTS auth_events (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NULL,
        `type` ENUM('login_success','login_failure','logout','password_reset','lockout') NOT NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        user_agent VARCHAR(1024) NULL,
        occurred_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        meta JSON NULL,
        meta_email VARCHAR(255) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(meta, '$.email'))) STORED,
        INDEX idx_auth_meta_email (meta_email),
        INDEX idx_auth_user (user_id),
        INDEX idx_auth_time (occurred_at),
        INDEX idx_auth_type_time (`type`, occurred_at),
        INDEX idx_auth_ip_hash (ip_hash)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE auth_events ADD CONSTRAINT fk_auth_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  audit_log:
    create: |-
      CREATE TABLE IF NOT EXISTS audit_log (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        table_name VARCHAR(100) NOT NULL,
        record_id BIGINT UNSIGNED NOT NULL,
        changed_by BIGINT UNSIGNED NULL,
        change_type ENUM('INSERT','UPDATE','DELETE') NOT NULL,
        old_value JSON NULL,
        new_value JSON NULL,
        changed_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        ip_bin VARBINARY(16) NULL,
        user_agent VARCHAR(1024) NULL,
        request_id VARCHAR(100) NULL
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE audit_log ADD CONSTRAINT fk_audit_log_user FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_audit_table_record ON audit_log (table_name, record_id, changed_at)
      - CREATE INDEX idx_audit_changed_at   ON audit_log (changed_at)
      - CREATE INDEX idx_audit_request_id   ON audit_log (request_id)
  device_fingerprints:
    DefaultOrder: last_seen DESC
    create: |-
      CREATE TABLE IF NOT EXISTS device_fingerprints (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT UNSIGNED NULL,
        fingerprint_hash BINARY(32) NOT NULL,
        attributes JSON NULL,
        risk_score TINYINT UNSIGNED NULL,
        first_seen DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        last_seen DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        last_ip_hash BINARY(32) NULL,
        last_ip_key_version VARCHAR(64) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_device_fp (fingerprint_hash),
        INDEX idx_df_user      (user_id),
        INDEX idx_df_last_seen (last_seen)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE device_fingerprints ADD CONSTRAINT fk_df_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_df_user_last_seen ON device_fingerprints (user_id, last_seen)
    Upsert:
      Update:
        - user_id
        - attributes
        - risk_score
        - last_seen
        - last_ip_hash
        - last_ip_key_version
      Keys:
        - fingerprint_hash
  key_usage:
    create: |-
      CREATE TABLE IF NOT EXISTS key_usage (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        key_id BIGINT UNSIGNED NOT NULL,
        usage_date DATE NOT NULL,
        encrypt_count INT NOT NULL DEFAULT 0,
        decrypt_count INT NOT NULL DEFAULT 0,
        verify_count INT NOT NULL DEFAULT 0,
        last_used_at DATETIME(6) NULL,
        UNIQUE KEY uq_key_usage_key_date (key_id, usage_date)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    DefaultOrder: usage_date DESC
    Aliases:
      date: usage_date
    Upsert:
      Update:
        - encrypt_count
        - decrypt_count
        - verify_count
        - last_used_at
      Keys:
        - key_id
        - usage_date
    indexes:
    foreign_keys:
      - ALTER TABLE key_usage ADD CONSTRAINT fk_key_usage_key FOREIGN KEY (key_id) REFERENCES crypto_keys(id) ON DELETE CASCADE
  rbac_repo_snapshots:
    DefaultOrder: taken_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS rbac_repo_snapshots (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        repo_id BIGINT UNSIGNED NOT NULL,
        commit_id VARCHAR(128) NOT NULL,
        taken_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        metadata JSON NULL,
        UNIQUE KEY uq_rbac_repo_snap (repo_id, commit_id)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE rbac_repo_snapshots ADD CONSTRAINT fk_rbac_snap_repo FOREIGN KEY (repo_id) REFERENCES rbac_repositories(id) ON DELETE CASCADE
    indexes:
    Upsert:
      Update:
        - taken_at
        - metadata
      Keys:
        - repo_id
        - commit_id
  jwt_tokens:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS jwt_tokens (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        jti CHAR(36) NOT NULL UNIQUE,
        user_id BIGINT UNSIGNED NULL,
        token_hash BINARY(32) NOT NULL,
        token_hash_algo VARCHAR(50) NULL,
        token_hash_key_version VARCHAR(64) NULL,
        `type` ENUM('refresh','api') NOT NULL DEFAULT 'refresh',
        scopes VARCHAR(255) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        expires_at DATETIME(6) NULL,
        last_used_at DATETIME(6) NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        replaced_by BIGINT UNSIGNED NULL,
        revoked BOOLEAN NOT NULL DEFAULT 0,
        meta JSON NULL,
        UNIQUE KEY uq_jwt_token_hash (token_hash),
        INDEX idx_jwt_user (user_id),
        INDEX idx_jwt_expires (expires_at),
        INDEX idx_jwt_revoked_user (revoked, user_id),
        INDEX idx_jwt_last_used (last_used_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE jwt_tokens ADD CONSTRAINT fk_jwt_tokens_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      - ALTER TABLE jwt_tokens ADD CONSTRAINT fk_jwt_tokens_replaced_by FOREIGN KEY (replaced_by) REFERENCES jwt_tokens(id) ON DELETE SET NULL
    indexes:
      - CREATE INDEX idx_jwt_replaced_by ON jwt_tokens (replaced_by)
    Upsert:
      Update:
        - jti
        - user_id
        - token_hash_algo
        - token_hash_key_version
        - type
        - scopes
        - expires_at
        - last_used_at
        - ip_hash
        - ip_hash_key_version
        - replaced_by
        - revoked
        - meta
      Keys:
        - token_hash
  app_settings:
    create: |-
      CREATE TABLE IF NOT EXISTS app_settings (
        setting_key VARCHAR(100) PRIMARY KEY,
        setting_value TEXT NULL,
        `type` VARCHAR(20) NOT NULL,
        section VARCHAR(100) NULL,
        description TEXT NULL,
        is_protected BOOLEAN NOT NULL DEFAULT FALSE,
        updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        updated_by BIGINT UNSIGNED NULL,
        CONSTRAINT chk_app_settings_type CHECK (`type` IN ('string','int','bool','json','secret'))
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    UpdatedAt: updated_at
    DefaultOrder: setting_key ASC
    Upsert:
      Update:
        - setting_value
        - type
        - section
        - description
        - is_protected
        - updated_at
        - updated_by
        - version
      Keys:
        - setting_key
    indexes:
    foreign_keys:
      - ALTER TABLE app_settings ADD CONSTRAINT fk_app_settings_user FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL
  session_audit:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS session_audit (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        session_token_hash BINARY(32) NULL,
        session_token_key_version VARCHAR(64) NULL,
        csrf_token_hash BINARY(32) NULL,
        csrf_key_version VARCHAR(64) NULL,
        session_id VARCHAR(128) NULL,
        `event` VARCHAR(64) NOT NULL,
        user_id BIGINT UNSIGNED NULL,
        ip_hash BINARY(32) NULL,
        ip_hash_key_version VARCHAR(64) NULL,
        user_agent VARCHAR(1024) NULL,
        meta_json JSON NULL,
        outcome VARCHAR(32) NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        INDEX idx_session_audit_token_hash (session_token_hash),
        INDEX idx_session_audit_session_id (session_id),
        INDEX idx_session_audit_user_id (user_id),
        INDEX idx_session_audit_created_at (created_at),
        INDEX idx_session_audit_event (`event`),
        INDEX idx_session_audit_ip_hash (ip_hash),
        INDEX idx_session_audit_ip_key (ip_hash_key_version),
        INDEX idx_session_audit_event_time (`event`, created_at),
        INDEX idx_session_audit_user_event_time (user_id, `event`, created_at),
        INDEX idx_session_audit_event_user_time (`event`, user_id, created_at),
        INDEX idx_session_audit_token_time (session_token_hash, created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE session_audit ADD CONSTRAINT fk_session_audit_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
    indexes:
  data_retention_policies:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS data_retention_policies (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        entity_table VARCHAR(64) NOT NULL,
        field_name VARCHAR(64) NULL,
        action ENUM('delete','anonymize','hash','truncate') NOT NULL,
        keep_for VARCHAR(64) NOT NULL,   -- e.g. "90 days"
        active BOOLEAN NOT NULL DEFAULT TRUE,
        notes TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY ux_drp (entity_table, field_name, action, keep_for),
        INDEX idx_drp_entity (entity_table, field_name),
        INDEX idx_drp_active (active)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - active
        - notes
      Keys:
        - entity_table
        - field_name
        - action
        - keep_for
  crypto_standard_aliases:
    DefaultOrder: alias ASC
    create: |-
      CREATE TABLE IF NOT EXISTS crypto_standard_aliases (
        alias VARCHAR(120) PRIMARY KEY,
        algo_id BIGINT UNSIGNED NOT NULL,
        notes TEXT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE crypto_standard_aliases ADD CONSTRAINT fk_crypto_alias_algo FOREIGN KEY (algo_id) REFERENCES crypto_algorithms(id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_crypto_alias_algo ON crypto_standard_aliases (algo_id)
    Upsert:
      Update:
        - algo_id
        - notes
      Keys:
        - alias
  merkle_roots:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS merkle_roots (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        subject_table VARCHAR(64) NOT NULL,
        period_start DATETIME(6) NOT NULL,
        period_end DATETIME(6) NOT NULL,
        root_hash BINARY(32) NOT NULL,
        proof_uri VARCHAR(512) NULL,
        status VARCHAR(32) NOT NULL DEFAULT 'pending',
        leaf_count BIGINT UNSIGNED NOT NULL,
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        UNIQUE KEY uq_merkle_subject_period (subject_table, period_start, period_end),
        INDEX idx_merkle_subject (subject_table),
        INDEX idx_merkle_created (created_at)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
    indexes:
    Upsert:
      Update:
        - root_hash
        - leaf_count
      Keys:
        - subject_table
        - period_start
        - period_end
  inventory_reservations:
    DefaultOrder: created_at DESC
    create: |-
      CREATE TABLE IF NOT EXISTS inventory_reservations (
        id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
        tenant_id BIGINT UNSIGNED NOT NULL,
        order_id BIGINT UNSIGNED NULL,
        book_id BIGINT UNSIGNED NOT NULL,
        quantity INT UNSIGNED NOT NULL,
        reserved_until DATETIME(6) NOT NULL,
        status ENUM('pending','confirmed','expired','cancelled') NOT NULL DEFAULT 'pending',
        created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
        version INT UNSIGNED NOT NULL DEFAULT 0,
        INDEX idx_res_book (book_id),
        INDEX idx_res_order (order_id),
        INDEX idx_res_status_until (status, reserved_until),
        CONSTRAINT chk_res_qty CHECK (quantity > 0)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci ROW_FORMAT=DYNAMIC;
    foreign_keys:
      - ALTER TABLE inventory_reservations ADD CONSTRAINT fk_res_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE RESTRICT
      - ALTER TABLE inventory_reservations ADD CONSTRAINT fk_res_book FOREIGN KEY (tenant_id, book_id) REFERENCES books(tenant_id, id) ON DELETE CASCADE
      - ALTER TABLE inventory_reservations ADD CONSTRAINT fk_res_order FOREIGN KEY (tenant_id, order_id) REFERENCES orders(tenant_id, id) ON DELETE CASCADE
    indexes:
      - CREATE INDEX idx_inventory_reservations_order ON inventory_reservations (order_id)
      - CREATE INDEX idx_res_book_status ON inventory_reservations (book_id, status)
      - CREATE INDEX idx_res_tenant_status_until ON inventory_reservations (tenant_id, status, reserved_until)
FormatVersion: 1.1
