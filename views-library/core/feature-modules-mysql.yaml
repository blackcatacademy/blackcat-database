Views:
  book_assets_catalog_health_summary:
    create: |-
      -- High-level catalog health
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_book_assets_catalog_health_summary AS
      SELECT
        (SELECT COUNT(*) FROM authors WHERE deleted_at IS NULL) AS authors_live,
        (SELECT COUNT(*) FROM categories WHERE deleted_at IS NULL) AS categories_live,
        (SELECT COUNT(*) FROM books WHERE deleted_at IS NULL) AS books_live,
        (SELECT COUNT(*) FROM books b
           WHERE b.deleted_at IS NULL
             AND NOT EXISTS (SELECT 1 FROM book_assets a WHERE a.book_id = b.id AND a.asset_type='cover')) AS books_missing_cover,
        (SELECT COUNT(*) FROM books b
           WHERE b.is_active AND b.is_available AND (b.stock_quantity IS NULL OR b.stock_quantity > 0)) AS books_saleable;
    Owner: blackcat-catalog
    RequiresTempTable: True
  key_wrappers_missing_pq:
    create: |-
      -- Wrappers without any PQ layer
      CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_key_wrappers_missing_pq AS
      SELECT
        kw.id,
        kw.wrapper_uuid,
        kw.status,
        kw.created_at
      FROM key_wrappers kw
      WHERE NOT EXISTS (
        SELECT 1
        FROM key_wrapper_layers kwl
        JOIN crypto_algorithms ca ON ca.id = kwl.kem_algo_id
        WHERE kwl.key_wrapper_id = kw.id AND ca.nist_level IS NOT NULL
      );
    Owner: blackcat-database-crypto
  peer_health:
    create: |-
      -- Peer health with last lag samples
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_peer_health AS
      WITH ranked AS (
        SELECT
          peer_id,
          metric,
          value,
          captured_at,
          ROW_NUMBER() OVER (PARTITION BY peer_id, metric ORDER BY captured_at DESC) AS rn
        FROM replication_lag_samples
      )
      SELECT
        p.id        AS peer_id,
        p.name,
        p.type,
        p.location,
        p.status,
        p.last_seen,
        COALESCE(MAX(CASE WHEN r.metric = 'apply_lag_ms' THEN r.value END), 0)    AS apply_lag_ms,
        COALESCE(MAX(CASE WHEN r.metric = 'transport_lag_ms' THEN r.value END), 0) AS transport_lag_ms,
        MAX(r.captured_at) AS lag_sampled_at
      FROM peer_nodes p
      LEFT JOIN ranked r ON r.peer_id = p.id AND r.rn = 1
      GROUP BY p.id, p.name, p.type, p.location, p.status, p.last_seen;
    Owner: blackcat-monitoring
    RequiresTempTable: True
  key_wrapper_layers_pq_readiness_summary:
    create: |-
      -- One-row PQ readiness snapshot
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_key_wrapper_layers_pq_readiness_summary AS
      SELECT
        (SELECT COUNT(*) FROM crypto_algorithms WHERE class='kem' AND status='active' AND nist_level IS NOT NULL) AS active_pq_kems,
        (SELECT COUNT(*) FROM crypto_algorithms WHERE class='sig' AND status='active' AND nist_level IS NOT NULL) AS active_pq_sigs,
        (SELECT COUNT(DISTINCT kw.id)
           FROM key_wrappers kw
           JOIN key_wrapper_layers kwl ON kwl.key_wrapper_id = kw.id
           JOIN crypto_algorithms ca ON ca.id = kwl.kem_algo_id
          WHERE ca.nist_level IS NOT NULL) AS wrappers_with_pq_layers,
        (SELECT COUNT(*)
           FROM signatures s
           JOIN crypto_algorithms ca ON ca.id = s.algo_id
          WHERE ca.class='sig' AND ca.nist_level IS NOT NULL) AS pq_signatures_total;
    Owner: blackcat-database-crypto
    RequiresTempTable: True
  sync_batches_channels_health:
    create: |-
      -- Sync channel health: last batch, success rate
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sync_batches_channels_health AS
      WITH batches AS (
        SELECT
          channel,
          COUNT(*) AS batches_total,
          SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) AS batches_success,
          SUM(CASE WHEN status = 'failed'  THEN 1 ELSE 0 END) AS batches_failed,
          MAX(finished_at) AS last_finished_at
        FROM sync_batches
        GROUP BY channel
      )
      SELECT
        b.channel,
        b.batches_total,
        b.batches_success,
        b.batches_failed,
        CASE WHEN b.batches_total > 0 THEN ROUND(100.0 * b.batches_success / b.batches_total, 2) ELSE NULL END AS success_pct,
        b.last_finished_at
      FROM batches b;
    Owner: blackcat-database-sync
    RequiresTempTable: True
  replication_lag_latest:
    create: |-
      -- Latest replication lag samples per peer
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_replication_lag_latest AS
      SELECT
        ph.peer_id,
        ph.name,
        ph.type,
        ph.apply_lag_ms,
        ph.transport_lag_ms,
        ph.lag_sampled_at
      FROM vw_peer_health ph;
    Owner: blackcat-monitoring
    RequiresTempTable: True
  slo_rollup:
    create: |-
      -- SLO last computed status
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_slo_rollup AS
      WITH ranked AS (
        SELECT
          w.id AS window_id,
          w.name,
          w.objective,
          w.target_pct,
          w.window_interval,
          s.computed_at,
          s.sli_value,
          s.good_events,
          s.total_events,
          s.status,
          ROW_NUMBER() OVER (PARTITION BY w.id ORDER BY s.computed_at DESC) AS rn
        FROM slo_windows w
        LEFT JOIN slo_status s ON s.window_id = w.id
      )
      SELECT
        window_id,
        name,
        objective,
        target_pct,
        window_interval,
        computed_at,
        sli_value,
        good_events,
        total_events,
        status
      FROM ranked
      WHERE rn = 1;
    Owner: blackcat-sre
    RequiresTempTable: True
  coupon_redemptions_effectiveness:
    create: |-
      -- Redemptions and total discount per coupon
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_coupon_redemptions_effectiveness AS
      SELECT
        c.id,
        c.code,
        c.is_active,
        c.starts_at,
        c.ends_at,
        COUNT(cr.id)      AS redemptions,
        SUM(cr.amount_applied) AS total_applied
      FROM coupons c
      LEFT JOIN coupon_redemptions cr ON cr.coupon_id = c.id
      GROUP BY c.id, c.code, c.is_active, c.starts_at, c.ends_at
      ORDER BY redemptions DESC;
    Owner: blackcat-commerce
    RequiresTempTable: True
  sync_errors_by_peer:
    create: |-
      -- Recent sync errors grouped by peer/source
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sync_errors_by_peer AS
      SELECT
        peer_id,
        source,
        COUNT(*) AS errors_total,
        MAX(created_at) AS last_error_at
      FROM sync_errors
      WHERE created_at > NOW() - INTERVAL 7 DAY
      GROUP BY peer_id, source
      ORDER BY errors_total DESC, last_error_at DESC;
    Owner: blackcat-database-sync
    RequiresTempTable: True
  crypto_algorithms_deprecation:
    create: |-
      -- Algorithms nearing deprecation (status active but deprecation_date set)
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_crypto_algorithms_deprecation AS
      SELECT
        id,
        name,
        class,
        status,
        nist_level,
        created_at
      FROM crypto_algorithms
      WHERE status = 'deprecated'
      ORDER BY created_at ASC;
    Owner: blackcat-database-crypto
    RequiresTempTable: True
  key_wrapper_layers_summary:
    create: |-
      -- Key wrappers with layer counts and PQC flag
      CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_key_wrapper_layers_summary AS
      SELECT
        kw.id,
        kw.wrapper_uuid,
        kw.status,
        COUNT(kwl.id)                           AS layer_count,
        MIN(kwl.layer_no)                       AS first_layer_no,
        MAX(kwl.layer_no)                       AS last_layer_no,
        MAX(CASE WHEN ca.nist_level IS NOT NULL THEN 1 ELSE 0 END) AS has_pq_layer
      FROM key_wrappers kw
      LEFT JOIN key_wrapper_layers kwl ON kwl.key_wrapper_id = kw.id
      LEFT JOIN crypto_algorithms ca   ON ca.id = kwl.kem_algo_id
      GROUP BY kw.id, kw.wrapper_uuid, kw.status
      ORDER BY kw.id DESC;
    Owner: blackcat-database-crypto
    RequiresTempTable: True
FormatVersion: 1.1
