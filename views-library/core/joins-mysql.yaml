Views:
  rbac_conflicts:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_rbac_conflicts AS
            WITH allowed AS (
              SELECT user_id, permission_id, tenant_id, scope FROM rbac_user_permissions WHERE effect='allow'
              UNION
              SELECT ur.user_id, rp.permission_id, ur.tenant_id, ur.scope
              FROM rbac_user_roles ur
              JOIN rbac_role_permissions rp ON rp.role_id = ur.role_id AND rp.effect='allow'
              WHERE ur.status='active' AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
            ),
            denied AS (
              SELECT user_id, permission_id, tenant_id, scope FROM rbac_user_permissions WHERE effect='deny'
              UNION
              SELECT ur.user_id, rp.permission_id, ur.tenant_id, ur.scope
              FROM rbac_user_roles ur
              JOIN rbac_role_permissions rp ON rp.role_id = ur.role_id AND rp.effect='deny'
              WHERE ur.status='active' AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
            )
            SELECT DISTINCT
              a.user_id,
              a.permission_id,
              p.name AS permission_name,
              a.tenant_id,
              a.scope
            FROM allowed a
            JOIN denied d
              ON d.user_id = a.user_id
             AND d.permission_id = a.permission_id
             AND COALESCE(d.tenant_id, -1) = COALESCE(a.tenant_id, -1)
             AND COALESCE(d.scope, '') = COALESCE(a.scope, '')
            JOIN permissions p ON p.id = a.permission_id
  payments_recent_failures:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_payments_recent_failures AS
            SELECT
              p.*,
              TIMESTAMPDIFF(SECOND, p.created_at, NOW()) AS age_sec
            FROM payments p
            WHERE p.status = 'failed'
              AND p.created_at > NOW() - INTERVAL 24 HOUR
  login_hotspots_ip:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_login_hotspots_ip AS
            SELECT
              ip_hash,
              UPPER(HEX(ip_hash)) AS ip_hash_hex,
              SUM(CASE WHEN attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END)                             AS total_24h,
              SUM(CASE WHEN success = 0 AND attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END)             AS failed_24h,
              MAX(attempted_at) AS last_attempt_at
            FROM login_attempts
            GROUP BY ip_hash
            HAVING SUM(CASE WHEN success = 0 AND attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END) > 0
            ORDER BY failed_24h DESC, last_attempt_at DESC
  revenue_daily:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_revenue_daily AS
            SELECT
              DATE(created_at) AS day,
              SUM(CASE WHEN status IN ('paid','completed') THEN 1 ELSE 0 END) AS paid_orders,
              SUM(CASE WHEN status IN ('paid','completed') THEN total ELSE 0 END) AS revenue_gross,
              SUM(CASE WHEN status IN ('failed','cancelled') THEN 1 ELSE 0 END) AS lost_orders,
              SUM(CASE WHEN status IN ('failed','cancelled') THEN total ELSE 0 END) AS lost_total
            FROM orders
            GROUP BY DATE(created_at)
            ORDER BY day DESC
  rbac_effective_permissions:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_rbac_effective_permissions AS
            WITH allows AS (
              SELECT ur.user_id, rp.permission_id, ur.tenant_id, ur.scope
              FROM rbac_user_roles ur
              JOIN rbac_role_permissions rp ON rp.role_id = ur.role_id AND rp.effect = 'allow'
              WHERE ur.status='active' AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
              UNION
              SELECT up.user_id, up.permission_id, up.tenant_id, up.scope
              FROM rbac_user_permissions up WHERE up.effect = 'allow'
            ),
            denies AS (
              SELECT ur.user_id, rp.permission_id, ur.tenant_id, ur.scope
              FROM rbac_user_roles ur
              JOIN rbac_role_permissions rp ON rp.role_id = ur.role_id AND rp.effect = 'deny'
              WHERE ur.status='active' AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
              UNION
              SELECT up.user_id, up.permission_id, up.tenant_id, up.scope
              FROM rbac_user_permissions up WHERE up.effect = 'deny'
            )
            SELECT a.user_id, a.permission_id, a.tenant_id, a.scope
            FROM allows a
            LEFT JOIN denies d
              ON d.user_id = a.user_id
             AND d.permission_id = a.permission_id
             AND COALESCE(d.tenant_id, -1) = COALESCE(a.tenant_id, -1)
             AND COALESCE(d.scope, '') = COALESCE(a.scope, '')
            WHERE d.permission_id IS NULL
  orders_user_summary:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_orders_user_summary AS
            SELECT
              u.id AS user_id,
              COUNT(o.id) AS orders_count,
              SUM(CASE WHEN o.status IN ('paid','completed') THEN o.total ELSE 0 END) AS total_spent
            FROM users u
            LEFT JOIN orders o ON o.user_id = u.id
            GROUP BY u.id
  audit_activity_daily:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_audit_activity_daily AS
            SELECT
              DATE(changed_at) AS day,
              COUNT(*) AS total,
              SUM(CASE WHEN change_type = 'INSERT' THEN 1 ELSE 0 END) AS inserts,
              SUM(CASE WHEN change_type = 'UPDATE' THEN 1 ELSE 0 END) AS updates,
              SUM(CASE WHEN change_type = 'DELETE' THEN 1 ELSE 0 END) AS deletes
            FROM audit_log
            GROUP BY day
            ORDER BY day DESC
  notifications_due:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_notifications_due AS
            SELECT
              n.id,
              n.channel,
              n.status,
              n.next_attempt_at,
              n.last_attempt_at,
              n.created_at,
              TIMESTAMPDIFF(SECOND, n.created_at, NOW()) AS age_sec,
              TIMESTAMPDIFF(SECOND, COALESCE(n.last_attempt_at, n.created_at), NOW()) AS idle_sec
            FROM notifications n
            WHERE n.status IN ('pending','processing')
              AND (n.next_attempt_at IS NULL OR n.next_attempt_at <= NOW())
  cart_items_detailed:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_cart_items_detailed AS
            SELECT
              ci.id,
              ci.cart_id,
              ci.tenant_id,
              ci.book_id,
              ci.quantity,
              ci.unit_price,
              ci.currency,
              c.user_id,
              b.title      AS book_title,
              a.name       AS author_name
            FROM cart_items ci
            LEFT JOIN carts c
              ON c.id = ci.cart_id AND c.tenant_id = ci.tenant_id
            LEFT JOIN books b
              ON b.id = ci.book_id AND b.tenant_id = ci.tenant_id
            LEFT JOIN authors a
              ON a.id = b.author_id AND a.tenant_id = b.tenant_id
  rate_limit_counters_hotspots:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_rate_limit_counters_hotspots AS
            SELECT
              subject_type,
              subject_id,
              name,
              SUM(`count`) AS total_count
            FROM rate_limit_counters
            WHERE window_start > NOW() - INTERVAL 1 HOUR
            GROUP BY subject_type, subject_id, name
            HAVING SUM(`count`) > 0
            ORDER BY total_count DESC, subject_type, subject_id, name
  notifications_queue_metrics:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_notifications_queue_metrics AS
            WITH base AS (
              SELECT
                channel,
                status,
                COUNT(*) AS total,
                SUM(CASE WHEN status IN ('pending','processing') AND (next_attempt_at IS NULL OR next_attempt_at <= NOW())
                         THEN 1 ELSE 0 END) AS due_now
              FROM notifications
              GROUP BY channel, status
            ),
            ranked AS (
              SELECT
                channel,
                status,
                TIMESTAMPDIFF(SECOND, COALESCE(last_attempt_at, created_at), NOW()) AS age_sec,
                ROW_NUMBER() OVER (PARTITION BY channel, status ORDER BY TIMESTAMPDIFF(SECOND, COALESCE(last_attempt_at, created_at), NOW())) AS rn,
                COUNT(*) OVER (PARTITION BY channel, status) AS cnt
              FROM notifications
            )
            SELECT
              b.channel,
              b.status,
              b.total,
              b.due_now,
              MAX(CASE WHEN r.rn = CEIL(0.95 * r.cnt) THEN r.age_sec END) AS p95_age_sec
            FROM base b
            LEFT JOIN ranked r
              ON r.channel = b.channel AND r.status = b.status
            GROUP BY b.channel, b.status, b.total, b.due_now
  orders_funnel:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_orders_funnel AS
            SELECT
              COUNT(*) AS orders_total,
              SUM(CASE WHEN status = 'pending'   THEN 1 ELSE 0 END) AS pending,
              SUM(CASE WHEN status = 'paid'      THEN 1 ELSE 0 END) AS paid,
              SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) AS completed,
              SUM(CASE WHEN status = 'failed'    THEN 1 ELSE 0 END) AS failed,
              SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) AS cancelled,
              SUM(CASE WHEN status = 'refunded'  THEN 1 ELSE 0 END) AS refunded,
              ROUND(
                100.0 * SUM(CASE WHEN status IN ('paid','completed') THEN 1 ELSE 0 END) / NULLIF(COUNT(*), 0),
                2
              ) AS payment_conversion_pct
            FROM orders
  kms_keys_status_by_provider:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_kms_keys_status_by_provider AS
            SELECT
              p.provider,
              p.name AS provider_name,
              COUNT(k.id) AS total,
              SUM(CASE WHEN k.status = 'active'   THEN 1 ELSE 0 END) AS active,
              SUM(CASE WHEN k.status = 'retired'  THEN 1 ELSE 0 END) AS retired,
              SUM(CASE WHEN k.status = 'disabled' THEN 1 ELSE 0 END) AS disabled
            FROM kms_keys k
            JOIN kms_providers p ON p.id = k.provider_id
            GROUP BY p.provider, p.name
            ORDER BY p.provider, p.name
  invoices_with_items:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_invoices_with_items AS
            SELECT
              i.id,
              i.tenant_id,
              i.order_id,
              i.invoice_number,
              i.total,
              i.currency,
              i.issue_date,
              i.due_date,
              COUNT(ii.id) AS items_count,
              SUM(ii.line_total) AS items_total
            FROM invoices i
            LEFT JOIN invoice_items ii
              ON ii.invoice_id = i.id AND ii.tenant_id = i.tenant_id
            GROUP BY i.id, i.tenant_id, i.order_id, i.invoice_number, i.total, i.currency, i.issue_date, i.due_date
  payments_status_summary:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_payments_status_summary AS
            SELECT
              gateway,
              status,
              COUNT(*) AS total,
              SUM(CASE WHEN status IN ('authorized','paid','partially_refunded','refunded') THEN amount ELSE 0 END) AS sum_amount
            FROM payments
            GROUP BY gateway, status
  schema_versions_latest:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_schema_versions_latest AS
            WITH ranked AS (
              SELECT
                system_name,
                component,
                version,
                checksum,
                applied_at,
                meta,
                ROW_NUMBER() OVER (PARTITION BY system_name, component ORDER BY applied_at DESC) AS rn
              FROM schema_registry
            )
            SELECT
              system_name,
              component,
              version,
              checksum,
              applied_at,
              meta
            FROM ranked
            WHERE rn = 1
            ORDER BY system_name, component
  rbac_user_roles_permissions:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_rbac_user_roles_permissions AS
            WITH active_roles AS (
              SELECT ur.user_id, ur.role_id
              FROM rbac_user_roles ur
              WHERE ur.status = 'active' AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
            ),
            role_perms AS (
              SELECT ar.user_id, rp.permission_id
              FROM active_roles ar
              JOIN rbac_role_permissions rp ON rp.role_id = ar.role_id
              WHERE rp.effect = 'allow'
            )
            SELECT
              u.id AS user_id,
              COUNT(DISTINCT ar.role_id) AS active_roles,
              CONCAT('[', GROUP_CONCAT(DISTINCT rp.permission_id ORDER BY rp.permission_id SEPARATOR ','), ']') AS permission_ids
            FROM users u
            LEFT JOIN active_roles ar ON ar.user_id = u.id
            LEFT JOIN role_perms rp   ON rp.user_id = u.id
            GROUP BY u.id
  crypto_keys_latest:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_crypto_keys_latest AS
            SELECT
              basename,
              id,
              version,
              status,
              algorithm,
              key_type,
              activated_at,
              retired_at
            FROM (
              SELECT
                *,
                ROW_NUMBER() OVER (PARTITION BY basename ORDER BY version DESC) AS rn
              FROM crypto_keys
            ) ranked
            WHERE rn = 1
            ORDER BY basename
  carts_with_items:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_carts_with_items AS
            SELECT
              c.id,
              c.tenant_id,
              c.user_id,
              c.created_at,
              COUNT(ci.id) AS items_count,
              SUM(ci.price_snapshot * ci.quantity) AS subtotal,
              MIN(ci.currency) AS currency
            FROM carts c
            LEFT JOIN cart_items ci ON ci.cart_id = c.id AND ci.tenant_id = c.tenant_id
            GROUP BY c.id, c.tenant_id, c.user_id, c.created_at
  sync_backlog_by_node:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sync_backlog_by_node AS
            SELECT
              COALESCE(producer_node, '(unknown)') AS producer_node,
              event_type,
              SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) AS pending,
              SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END)  AS failed,
              COUNT(*) AS total
            FROM event_outbox
            GROUP BY COALESCE(producer_node, '(unknown)'), event_type
            ORDER BY pending DESC, failed DESC
  orders_payments_latest:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_orders_payments_latest AS
            WITH ranked_payments AS (
              SELECT
                p.*,
                ROW_NUMBER() OVER (PARTITION BY p.tenant_id, p.order_id ORDER BY p.created_at DESC, p.id DESC) AS rn
              FROM payments p
            )
            SELECT
              o.id          AS order_id,
              o.tenant_id,
              o.user_id,
              o.status      AS order_status,
              o.total       AS order_total,
              o.currency    AS order_currency,
              rp.gateway    AS payment_gateway,
              rp.status     AS payment_status,
              rp.amount     AS payment_amount,
              rp.currency   AS payment_currency,
              rp.created_at AS payment_created_at
            FROM orders o
            LEFT JOIN ranked_payments rp
              ON rp.tenant_id = o.tenant_id
             AND rp.order_id  = o.id
             AND rp.rn = 1
  rate_limit_usage:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_rate_limit_usage AS
            SELECT
              subject_type,
              subject_id,
              name,
              SUM(`count`) AS total_count,
              MIN(window_start) AS first_window,
              MAX(window_start) AS last_window
            FROM rate_limit_counters
            WHERE window_start > NOW() - INTERVAL 1 HOUR
            GROUP BY subject_type, subject_id, name
            ORDER BY total_count DESC
  event_outbox_due:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_event_outbox_due AS
            SELECT
              eo.id,
              eo.event_type,
              eo.status,
              eo.attempts,
              eo.created_at,
              eo.next_attempt_at,
              TIMESTAMPDIFF(SECOND, eo.created_at, NOW()) AS age_sec,
              TIMESTAMPDIFF(SECOND, COALESCE(eo.next_attempt_at, eo.created_at), NOW()) AS since_next_sec
            FROM event_outbox eo
            WHERE eo.status IN ('pending','failed')
              AND (eo.next_attempt_at IS NULL OR eo.next_attempt_at <= NOW())
  event_outbox_metrics:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_event_outbox_metrics AS
            WITH base AS (
              SELECT
                event_type,
                COUNT(*) AS total,
                SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) AS pending,
                SUM(CASE WHEN status = 'sent'     THEN 1 ELSE 0 END) AS sent,
                SUM(CASE WHEN status = 'failed'   THEN 1 ELSE 0 END) AS failed,
                AVG(TIMESTAMPDIFF(SECOND, created_at, NOW())) AS avg_created_lag_sec,
                AVG(attempts) AS avg_attempts,
                MAX(attempts) AS max_attempts,
                SUM(CASE WHEN status IN ('pending','failed') AND (next_attempt_at IS NULL OR next_attempt_at <= NOW())
                         THEN 1 ELSE 0 END) AS due_now
              FROM event_outbox
              GROUP BY event_type
            ),
            ranked AS (
              SELECT
                event_type,
                TIMESTAMPDIFF(SECOND, created_at, NOW()) AS lag_sec,
                ROW_NUMBER() OVER (PARTITION BY event_type ORDER BY TIMESTAMPDIFF(SECOND, created_at, NOW())) AS rn,
                COUNT(*) OVER (PARTITION BY event_type) AS cnt
              FROM event_outbox
            ),
            pcts AS (
              SELECT
                event_type,
                MAX(CASE WHEN rn = CEIL(0.50 * cnt) THEN lag_sec END) AS p50_created_lag_sec,
                MAX(CASE WHEN rn = CEIL(0.95 * cnt) THEN lag_sec END) AS p95_created_lag_sec
              FROM ranked
              GROUP BY event_type
            )
            SELECT
              b.event_type,
              b.total,
              b.pending,
              b.sent,
              b.failed,
              b.avg_created_lag_sec,
              p.p50_created_lag_sec,
              p.p95_created_lag_sec,
              b.avg_attempts,
              b.max_attempts,
              b.due_now
            FROM base b
            LEFT JOIN pcts p ON p.event_type = b.event_type
  global_id_map:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_global_id_map AS
            SELECT
              gid,
              guid,
              entity_table,
              entity_pk,
              created_at
            FROM global_id_registry
  retention_due:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_retention_due AS
            -- NOTE: keep_for is stored as textual duration in MySQL, so due_from_now is emitted as NULL.
            SELECT
              id,
              entity_table,
              field_name,
              action,
              keep_for,
              active,
              NULL AS due_from_now,
              notes,
              created_at
            FROM data_retention_policies
            WHERE active
  sync_batch_progress:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sync_batch_progress AS
            SELECT
              b.id,
              b.channel,
              b.status,
              b.items_total,
              b.items_ok,
              b.items_failed,
              ROUND(100.0 * b.items_ok / NULLIF(b.items_total, 0), 2) AS success_pct,
              b.created_at,
              b.started_at,
              b.finished_at
            FROM sync_batches b
            ORDER BY b.created_at DESC
  audit_chain_gaps:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_audit_chain_gaps AS
            SELECT
              al.id AS audit_id,
              al.changed_at,
              al.table_name,
              al.record_id
            FROM audit_log al
            LEFT JOIN audit_chain ac ON ac.audit_id = al.id
            WHERE ac.audit_id IS NULL
            ORDER BY al.changed_at DESC
  event_throughput_hourly:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_event_throughput_hourly AS
            SELECT
              hour_ts,
              SUM(outbox_cnt) AS outbox_cnt,
              SUM(inbox_cnt)  AS inbox_cnt
            FROM (
              SELECT
                DATE_FORMAT(created_at, '%Y-%m-%d %H:00:00') AS hour_ts,
                COUNT(*) AS outbox_cnt,
                0 AS inbox_cnt
              FROM event_outbox
              GROUP BY hour_ts
              UNION ALL
              SELECT
                DATE_FORMAT(received_at, '%Y-%m-%d %H:00:00') AS hour_ts,
                0 AS outbox_cnt,
                COUNT(*) AS inbox_cnt
              FROM event_inbox
              GROUP BY hour_ts
            ) t
            GROUP BY hour_ts
  merkle_latest:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_merkle_latest AS
            WITH ranked AS (
              SELECT
                subject_table,
                period_start,
                period_end,
                leaf_count,
                root_hash,
                created_at,
                ROW_NUMBER() OVER (PARTITION BY subject_table ORDER BY created_at DESC) AS rn
              FROM merkle_roots
            )
            SELECT
              subject_table,
              period_start,
              period_end,
              leaf_count,
              UPPER(HEX(root_hash)) AS root_hash_hex,
              created_at
            FROM ranked
            WHERE rn = 1
            ORDER BY subject_table
  book_assets_encryption_coverage:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_book_assets_encryption_coverage AS
            SELECT
              asset_type,
              COUNT(*) AS total,
              SUM(CASE WHEN is_encrypted THEN 1 ELSE 0 END) AS encrypted,
              ROUND(100.0 * SUM(CASE WHEN is_encrypted THEN 1 ELSE 0 END) / NULLIF(COUNT(*), 0), 2) AS pct_encrypted
            FROM book_assets
            GROUP BY asset_type
  books_with_assets:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_books_with_assets AS
            SELECT
              b.id,
              b.tenant_id,
              b.title,
              b.is_active,
              b.is_available,
              SUM(CASE WHEN ba.asset_type = 'cover' THEN 1 ELSE 0 END) AS cover_assets,
              SUM(CASE WHEN ba.asset_type IN ('pdf','epub','mobi','sample','extra') THEN 1 ELSE 0 END) AS downloadable_assets
            FROM books b
            LEFT JOIN book_assets ba
              ON ba.tenant_id = b.tenant_id AND ba.book_id = b.id
            GROUP BY b.id, b.tenant_id, b.title, b.is_active, b.is_available
  sessions_active_by_user:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sessions_active_by_user AS
            SELECT
              user_id,
              COUNT(*) AS active_sessions,
              MIN(created_at) AS first_created_at,
              MAX(last_seen_at) AS last_seen_at
            FROM sessions
            WHERE revoked = 0 AND (expires_at IS NULL OR expires_at > NOW())
            GROUP BY user_id
            ORDER BY active_sessions DESC
  kms_health_latest:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_kms_health_latest AS
            WITH ranked AS (
              SELECT
                id,
                provider_id,
                kms_key_id,
                status,
                latency_ms,
                error,
                checked_at,
                ROW_NUMBER() OVER (
                  PARTITION BY COALESCE(kms_key_id, -1), COALESCE(provider_id, -1)
                  ORDER BY checked_at DESC
                ) AS rn
              FROM kms_health_checks
            )
            SELECT
              id,
              provider_id,
              kms_key_id,
              status,
              latency_ms,
              error,
              checked_at
            FROM ranked
            WHERE rn = 1
  payments_with_logs:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_payments_with_logs AS
            WITH ranked_logs AS (
              SELECT
                pl.*,
                ROW_NUMBER() OVER (PARTITION BY pl.payment_id ORDER BY pl.log_at DESC, pl.id DESC) AS rn
              FROM payment_logs pl
            )
            SELECT
              p.*,
              rl.message   AS last_log_message,
              rl.log_at    AS last_log_at,
              (SELECT COUNT(*) FROM payment_logs x WHERE x.payment_id = p.id) AS logs_count
            FROM payments p
            LEFT JOIN ranked_logs rl ON rl.payment_id = p.id AND rl.rn = 1
  refunds_daily:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_refunds_daily AS
            SELECT
              DATE(r.created_at) AS day,
              SUM(r.amount) AS refunds_total,
              COUNT(*)      AS refunds_count
            FROM refunds r
            GROUP BY DATE(r.created_at)
            ORDER BY day DESC
  privacy_requests_status:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_privacy_requests_status AS
            SELECT
              type,
              status,
              COUNT(*) AS total,
              MAX(processed_at) AS last_processed
            FROM privacy_requests
            GROUP BY type, status
            ORDER BY type, status
  books_inventory_status:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_books_inventory_status AS
            SELECT
              b.id,
              b.tenant_id,
              b.title,
              b.stock_quantity,
              COALESCE(SUM(ir.quantity), 0) AS reserved_quantity,
              b.stock_quantity - COALESCE(SUM(ir.quantity), 0) AS available_quantity
            FROM books b
            LEFT JOIN inventory_reservations ir
              ON ir.tenant_id = b.tenant_id AND ir.book_id = b.id
            GROUP BY b.id, b.tenant_id, b.title, b.stock_quantity
  sync_failures_recent:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_sync_failures_recent AS
            SELECT
              e.id,
              e.source,
              e.event_key,
              e.peer_id,
              e.error,
              e.created_at
            FROM sync_errors e
            WHERE e.created_at > NOW() - INTERVAL 24 HOUR
            ORDER BY e.created_at DESC
  refunds_by_day_and_gateway:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_refunds_by_day_and_gateway AS
            SELECT
              DATE(r.created_at) AS day,
              p.gateway,
              SUM(r.amount) AS refunds_total,
              COUNT(*)      AS refunds_count
            FROM refunds r
            JOIN payments p ON p.id = r.payment_id
            GROUP BY DATE(r.created_at), p.gateway
            ORDER BY day DESC, gateway
  system_errors_daily:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_system_errors_daily AS
            SELECT
              DATE(created_at) AS day,
              level,
              COUNT(*) AS count
            FROM system_errors
            GROUP BY DATE(created_at), level
            ORDER BY day DESC, level
  tax_rates_current:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_tax_rates_current AS
            SELECT
              *
            FROM tax_rates t
            WHERE CURRENT_DATE() >= t.valid_from
              AND (t.valid_to IS NULL OR CURRENT_DATE() <= t.valid_to)
  deletion_jobs_status:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_deletion_jobs_status AS
            SELECT
              status,
              COUNT(*) AS jobs,
              MAX(finished_at) AS last_finished
            FROM deletion_jobs
            GROUP BY status
            ORDER BY status
  event_inbox_metrics:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_event_inbox_metrics AS
            WITH base AS (
              SELECT
                source,
                COUNT(*) AS total,
                SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END)   AS pending,
                SUM(CASE WHEN status = 'processed' THEN 1 ELSE 0 END) AS processed,
                SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END)    AS failed,
                AVG(attempts) AS avg_attempts
              FROM event_inbox
              GROUP BY source
            ),
            ranked AS (
              SELECT
                source,
                attempts,
                ROW_NUMBER() OVER (PARTITION BY source ORDER BY attempts) AS rn,
                COUNT(*) OVER (PARTITION BY source) AS cnt
              FROM event_inbox
            ),
            pcts AS (
              SELECT
                source,
                MAX(CASE WHEN rn = CEIL(0.95 * cnt) THEN attempts END) AS p95_attempts
              FROM ranked
              GROUP BY source
            )
            SELECT
              b.source,
              b.total,
              b.pending,
              b.processed,
              b.failed,
              b.avg_attempts,
              p.p95_attempts
            FROM base b
            LEFT JOIN pcts p ON p.source = b.source
  crypto_keys_inventory:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_crypto_keys_inventory AS
            SELECT
              key_type,
              status,
              COUNT(*) AS total
            FROM crypto_keys
            GROUP BY key_type, status
            ORDER BY key_type, status
  orders_with_user:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_orders_with_user AS
            SELECT
              o.id,
              o.tenant_id,
              o.user_id,
              u.email_hash,
              o.status,
              o.total,
              o.currency,
              o.created_at,
              (SELECT COUNT(*) FROM order_items oi WHERE oi.order_id = o.id) AS items_count
            FROM orders o
            LEFT JOIN users u ON u.id = o.user_id
  device_risk_recent:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_device_risk_recent AS
            SELECT
              d.id,
              d.user_id,
              d.risk_score,
              d.first_seen,
              d.last_seen,
              UPPER(HEX(d.fingerprint_hash)) AS fingerprint_hash_hex
            FROM device_fingerprints d
            WHERE d.last_seen > NOW() - INTERVAL 30 DAY
              AND d.risk_score IS NOT NULL
            ORDER BY d.risk_score DESC, d.last_seen DESC
  webhook_outbox_metrics:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_webhook_outbox_metrics AS
            SELECT
              status,
              COUNT(*) AS total,
              SUM(CASE WHEN status = 'pending' AND (next_attempt_at IS NULL OR next_attempt_at <= NOW()) THEN 1 ELSE 0 END) AS due_now
            FROM webhook_outbox
            GROUP BY status
  pq_migration_jobs_metrics:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_pq_migration_jobs_metrics AS
            SELECT
              status,
              COUNT(*) AS jobs,
              SUM(processed_count) AS processed_total
            FROM pq_migration_jobs
            GROUP BY status
            ORDER BY status
  system_jobs_metrics:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_system_jobs_metrics AS
            SELECT
              job_type,
              status,
              COUNT(*) AS total,
              SUM(CASE WHEN status = 'pending' AND (scheduled_at IS NULL OR scheduled_at <= NOW()) THEN 1 ELSE 0 END) AS due_now,
              SUM(CASE WHEN status = 'processing' THEN 1 ELSE 0 END) AS processing,
              SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) AS failed
            FROM system_jobs
            GROUP BY job_type, status
            ORDER BY job_type, status
  kms_routing_matrix:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_kms_routing_matrix AS
            SELECT
              name,
              priority,
              strategy,
              `match`,
              providers,
              active,
              created_at
            FROM kms_routing_policies
            WHERE active
  encrypted_fields_without_binding:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_encrypted_fields_without_binding AS
            SELECT
              e.id,
              e.entity_table,
              e.entity_pk,
              e.field_name,
              e.created_at,
              e.updated_at
            FROM encrypted_fields e
            LEFT JOIN encryption_bindings b
              ON b.entity_table = e.entity_table
             AND b.entity_pk    = e.entity_pk
             AND (b.field_name  = e.field_name OR b.field_name IS NULL)
            WHERE b.id IS NULL
  payments_anomalies:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_payments_anomalies AS
            SELECT
              p.*
            FROM payments p
            WHERE
              (status IN ('paid','authorized') AND amount < 0)
              OR (status = 'paid' AND (transaction_id IS NULL OR transaction_id = ''))
              OR (status = 'failed' AND amount > 0)
  encryption_policy_bindings_current:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_encryption_policy_bindings_current AS
            SELECT
              epb.entity_table,
              epb.field_name,
              epb.policy_id,
              epb.effective_from
            FROM encryption_policy_bindings epb
            WHERE epb.effective_from <= NOW()
              AND NOT EXISTS (
                SELECT 1
                FROM encryption_policy_bindings newer
                WHERE newer.entity_table = epb.entity_table
                  AND newer.field_name  = epb.field_name
                  AND newer.effective_from > epb.effective_from
                  AND newer.effective_from <= NOW()
              )
  refunds_with_payments:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_refunds_with_payments AS
            SELECT
              r.id           AS refund_id,
              r.tenant_id,
              r.payment_id,
              r.amount,
              r.currency,
              r.status       AS refund_status,
              r.created_at   AS refund_created_at,
              p.gateway      AS payment_gateway,
              p.status       AS payment_status,
              p.amount       AS payment_amount,
              p.created_at   AS payment_created_at
            FROM refunds r
            LEFT JOIN payments p
              ON p.id = r.payment_id AND p.tenant_id = r.tenant_id
  order_items_detailed:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_order_items_detailed AS
            SELECT
              oi.id,
              oi.order_id,
              oi.tenant_id,
              oi.book_id,
              oi.title_snapshot    AS item_title,
              oi.sku_snapshot      AS item_sku,
              oi.quantity,
              oi.unit_price,
              oi.currency,
              oi.tax_rate,
              o.user_id,
              o.status             AS order_status,
              b.title              AS book_title,
              a.name               AS author_name,
              c.name               AS category_name
            FROM order_items oi
            LEFT JOIN orders o
              ON o.tenant_id = oi.tenant_id AND o.id = oi.order_id
            LEFT JOIN books b
              ON b.tenant_id = oi.tenant_id AND b.id = oi.book_id
            LEFT JOIN authors a
              ON a.tenant_id = b.tenant_id AND a.id = b.author_id
            LEFT JOIN categories c
              ON c.tenant_id = b.tenant_id AND c.id = b.main_category_id
  event_outbox_latency:
    create: |-
            CREATE OR REPLACE ALGORITHM=MERGE SQL SECURITY INVOKER VIEW vw_event_outbox_latency AS
            SELECT
              ranked.event_type,
              ranked.processed,
              ranked.avg_latency_sec,
              ranked.max_latency_sec
            FROM (
              SELECT
                eo.event_type,
                COUNT(*) OVER (PARTITION BY eo.event_type) AS processed,
                AVG(TIMESTAMPDIFF(SECOND, eo.created_at, eo.processed_at))
                  OVER (PARTITION BY eo.event_type) AS avg_latency_sec,
                MAX(TIMESTAMPDIFF(SECOND, eo.created_at, eo.processed_at))
                  OVER (PARTITION BY eo.event_type) AS max_latency_sec,
                ROW_NUMBER() OVER (PARTITION BY eo.event_type ORDER BY eo.event_type) AS rn
              FROM event_outbox eo
              WHERE eo.processed_at IS NOT NULL
            ) ranked
            WHERE ranked.rn = 1
  login_attempts_activity:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_login_attempts_activity AS
            SELECT
              u.id AS user_id,
              MAX(l.attempted_at) AS last_attempt_at,
              SUM(CASE WHEN l.attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END) AS attempts_24h,
              SUM(CASE WHEN l.success = 0 AND l.attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END) AS failed_24h
            FROM users u
            LEFT JOIN login_attempts l ON l.user_id = u.id
            GROUP BY u.id
  login_hotspots_user:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_login_hotspots_user AS
            SELECT
              user_id,
              SUM(CASE WHEN attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END)                         AS total_24h,
              SUM(CASE WHEN success = 0 AND attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END)         AS failed_24h,
              MAX(attempted_at) AS last_attempt_at
            FROM login_attempts
            WHERE user_id IS NOT NULL
            GROUP BY user_id
            HAVING SUM(CASE WHEN success = 0 AND attempted_at > NOW() - INTERVAL 24 HOUR THEN 1 ELSE 0 END) > 0
            ORDER BY failed_24h DESC, last_attempt_at DESC
  system_errors_top_fingerprints:
    RequiresTempTable: True
    create: |-
            CREATE OR REPLACE ALGORITHM=TEMPTABLE SQL SECURITY INVOKER VIEW vw_system_errors_top_fingerprints AS
            SELECT
              fingerprint,
              MAX(message) AS sample_message,
              SUM(occurrences) AS occurrences,
              MIN(created_at) AS first_seen,
              MAX(last_seen)  AS last_seen,
              MAX(CASE WHEN resolved THEN 1 ELSE 0 END) AS any_resolved,
              COUNT(*) AS rows_count
            FROM system_errors
            GROUP BY fingerprint
            ORDER BY occurrences DESC, last_seen DESC
FormatVersion: 1.1
