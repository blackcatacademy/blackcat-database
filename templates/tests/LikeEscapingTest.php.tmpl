<?php
declare(strict_types=1);
use PHPUnit\Framework\TestCase;
use BlackCat\Core\Database;
final class {{Name}}LikeEscapingTest extends TestCase {
  public function test_like_escapes_wildcards_and_is_ci_on_pg(): void {
    $db = Database::getInstance();
    $tbl = '{{Table}}_like';
    $db->exec("DROP TABLE IF EXISTS $tbl");
    $db->exec($db->isPg()
      ? "CREATE TABLE $tbl (id BIGSERIAL PRIMARY KEY, v TEXT)"
      : "CREATE TABLE $tbl (id BIGINT PRIMARY KEY AUTO_INCREMENT, v VARCHAR(100))");
    $db->exec("INSERT INTO $tbl(v) VALUES ('foo%bar_'), ('FoO%BaR_'), ('zzz')");
    $needle = 'foo%bar_';
    $like = '%' . strtr($needle, ['\\'=>'\\\\','%'=>'\\%','_'=>'\\_']) . '%';
    $sql = $db->isPg() ? "SELECT COUNT(*) FROM $tbl WHERE v ILIKE :q ESCAPE '\\\\'"
                       : "SELECT COUNT(*) FROM $tbl WHERE v LIKE :q ESCAPE '\\\\'";
    $cnt = (int)$db->fetchOne($sql, [':q'=>$like]);
    $this->assertGreaterThanOrEqual(1, $cnt);
  }
}