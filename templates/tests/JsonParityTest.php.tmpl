<?php
declare(strict_types=1);
use PHPUnit\Framework\TestCase;
use BlackCat\Core\Database;
final class {{Name}}JsonParityTest extends TestCase {
  public function test_json_contains_and_extract(): void {
    $db = Database::getInstance();
    $tbl = '{{Table}}_js';
    $db->exec("DROP TABLE IF EXISTS $tbl");
    $db->exec($db->isPg()
      ? "CREATE TABLE $tbl (id BIGSERIAL PRIMARY KEY, payload JSONB NOT NULL)"
      : "CREATE TABLE $tbl (id BIGINT PRIMARY KEY AUTO_INCREMENT, payload JSON NOT NULL)");
    $db->exec("INSERT INTO $tbl(payload) VALUES (:j)", [':j'=>json_encode(['a'=>1,'b'=>['c'=>'x']])]);

    if ($db->isPg()) {
      $cnt = (int)$db->fetchOne("SELECT COUNT(*) FROM $tbl WHERE payload @> :n::jsonb", [':n'=>'{\"a\":1}']);
      $c   = (string)$db->fetchOne("SELECT payload->'b'->>'c' FROM $tbl LIMIT 1");
    } else {
      $cnt = (int)$db->fetchOne("SELECT COUNT(*) FROM $tbl WHERE JSON_CONTAINS(payload, JSON_OBJECT('a',1))");
      $c   = (string)$db->fetchOne("SELECT JSON_UNQUOTE(JSON_EXTRACT(payload,'$.b.c')) FROM $tbl LIMIT 1");
    }
    $this->assertSame(1, $cnt);
    $this->assertSame('x', $c);
  }
}