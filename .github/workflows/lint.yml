name: Lint (SQL)

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Use PowerShell 7
        shell: bash
        run: pwsh -v

      - name: Lint SQL (PK/FK indexes/views directives)
        shell: pwsh
        run: |
          $candidates = @(
            'scripts/schema/schema-map-postgres.yaml',
            'scripts/schema/schema-map-mysql.yaml'
          )
          $found = @()
          foreach ($cand in $candidates) {
            $full = Join-Path (Get-Location).Path $cand
            if (Test-Path -LiteralPath $full) { $found += (Resolve-Path -LiteralPath $full).Path }
          }
          if ($found.Count -eq 0) { throw "schema map file not found (looked in $candidates)" }

          foreach ($mapPath in $found) {
            Write-Host "Linting map: $mapPath" -ForegroundColor Cyan
            pwsh ./scripts/schema-tools/Lint-Sql.ps1 `
              -PackagesDir ./packages `
              -MapPath $mapPath
          }
