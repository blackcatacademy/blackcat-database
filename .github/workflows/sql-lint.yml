name: SQL Lint (diff)

on:
  pull_request:
    paths:
      - '**/*.sql'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with: { fetch-depth: 0 }
      - uses: actions/setup-python@v5
        with: { python-version: '3.x' }
      - name: Run sqlfluff on changed files
        run: bash ./scripts/quality/SqlLint-Diff.sh
      - name: Comment PR with lint summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            let list='';
            try { list = fs.readFileSync('sqlfluff.new.txt','utf8'); } catch(e) {}
            const has = !!(list && list.trim());
            const lines = [
              '<!-- sql-lint-report -->',
              '### ðŸ§¹ SQL Lint (diff)',
              has
                ? '**New violations detected**:\n```\n' + list + '\n```'
                : 'No new violations vs baseline.'
            ];
            const body = lines.join('\n');
            const comments = await github.rest.issues.listComments({owner, repo, issue_number, per_page: 100});
            const existing = comments.data.find(c => c.body && c.body.includes('<!-- sql-lint-report -->'));
            if (existing) {
              await github.rest.issues.updateComment({owner, repo, comment_id: existing.id, body});
            } else {
              await github.rest.issues.createComment({owner, repo, issue_number, body});
            }
      - name: Label PR on lint fail
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            try { await github.rest.issues.addLabels({owner, repo, issue_number, labels: ['lint:sql-fail']}); } catch(e) {}
      - name: Remove lint label on pass
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            try { await github.rest.issues.removeLabel({owner, repo, issue_number, name: 'lint:sql-fail'}); } catch(e) {}
