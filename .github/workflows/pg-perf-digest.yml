name: PG Perf Digest

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  digest:
    runs-on: ubuntu-latest
    env:
      DB_DSN: ${{ secrets.DB_DSN_PG || secrets.DB_DSN }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK || '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP & Python
        uses: actions/setup-python@v5
        with: { python-version: '3.x' }
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo_pgsql
      - name: Collect digest
        run: php scripts/bench/PG-PerfDigest.php --dsn "$DB_DSN" --user "$DB_USER" --pass "$DB_PASS" --out perf
      - name: Plot
        run: |
          pip install matplotlib
          python3 scripts/bench/PerfDigest-Plot.py --in perf/digest.json --outdir perf
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pg-perf-${{ github.run_id }}
          path: perf/**
      - name: Optional Slack notify
        if: env.SLACK_WEBHOOK != ''
        run: |
          payload=$(python3 -c "import json, pathlib; lines = pathlib.Path('perf/digest.md').read_text(encoding='utf-8').splitlines(); snippet = '\n'.join(lines[:20]); print(json.dumps({'text': 'PG Perf Digest (top20 lines)\n' + snippet}))")
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK"
