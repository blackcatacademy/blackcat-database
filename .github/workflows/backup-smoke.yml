name: Backup-Restore Smoke

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  pg:
    runs-on: ubuntu-latest
    env:
      DB_DSN: ${{ secrets.DB_DSN_PG || secrets.DB_DSN }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
    steps:
      - uses: actions/checkout@v6
      - name: Install PG tools
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Run PG backup-restore
        run: bash scripts/dbops/PG-BackupRestore.sh "$DB_DSN" "$DB_USER" "$DB_PASS"
      - name: Label PR on fail (PG)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            await github.rest.issues.addLabels({owner, repo, issue_number, labels: ['backup:fail']});
      - name: Remove backup label on pass (PG)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            try { await github.rest.issues.removeLabel({owner, repo, issue_number, name: 'backup:fail'}); } catch (e) { core.info('Label not present'); }
  mysql:
    runs-on: ubuntu-latest
    env:
      DB_DSN: ${{ secrets.DB_DSN_MY || secrets.DB_DSN }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
    steps:
      - uses: actions/checkout@v6
      - name: Install MySQL client
        run: sudo apt-get update && sudo apt-get install -y mysql-client
      - name: Run MySQL backup-restore
        run: bash scripts/dbops/MySQL-BackupRestore.sh "$DB_DSN" "$DB_USER" "$DB_PASS"
      - name: Label PR on fail (MySQL)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            await github.rest.issues.addLabels({owner, repo, issue_number, labels: ['backup:fail']});
      - name: Remove backup label on pass (MySQL)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            try { await github.rest.issues.removeLabel({owner, repo, issue_number, name: 'backup:fail'}); } catch (e) { core.info('Label not present'); }
