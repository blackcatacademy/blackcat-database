name: TLS Matrix (PG)

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  tls:
    runs-on: ubuntu-latest
    env:
      DB_DSN: ${{ secrets.DB_DSN_PG || secrets.DB_DSN }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASS: ${{ secrets.DB_PASS }}
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with: { php-version: '8.2', extensions: pdo_pgsql }
      - name: Run matrix
        run: php scripts/dbops/TlsMatrix.php --dsn "$DB_DSN" --user "$DB_USER" --pass "$DB_PASS" --out tls | tee tls/result.log
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tls-matrix-${{ github.sha }}
          path: tls/**
      - name: Label PR if insecure
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const log = fs.readFileSync('tls/result.log', 'utf8');
            if (log.includes('INSECURE_ONLY')) {
              await github.rest.issues.addLabels({owner, repo, issue_number, labels: ['tls:insecure']});
            } else {
              try { await github.rest.issues.removeLabel({owner, repo, issue_number, name: 'tls:insecure'}); } catch(e) {}
            }
