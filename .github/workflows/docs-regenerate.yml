name: PR Docs Regenerate

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  docs:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/docs regenerate')
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR head ref
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const prnum = context.issue.number;
            const pr = await github.rest.pulls.get({owner, repo, pull_number: prnum});
            core.setOutput('ref', pr.data.head.ref);

      - name: Checkout PR head (with submodules, writeable)
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr.outputs.ref || github.sha }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup PowerShell (pwsh)
        run: pwsh -v

      - name: Rebuild package docs (definitions, indexes, readmes, changelogs)
        shell: pwsh
        run: |
          pwsh ./scripts/schema-tools/Build-Definitions.ps1 -Force
          pwsh ./scripts/docs/New-PackageReadmes.ps1 -Force
          pwsh ./scripts/docs/New-PackageChangelogs.ps1 -Force
          pwsh ./scripts/docs/New-DocsIndex.ps1 -Force
          pwsh ./scripts/schema-tools/Generate-MermaidERD.ps1 -Force
          pwsh ./scripts/packages/Audit-Packages.ps1 -Force

      - name: Detect changes
        id: diff
        run: |
          git config user.email "actions@users.noreply.github.com"
          git config user.name  "GitHub Actions"
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated docs
        if: steps.diff.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: regenerate (CI)"
          commit_user_name: "blackcat-bot"
          commit_user_email: "actions@users.noreply.github.com"
          file_pattern: |
            docs/**
            packages/**/README.md
            packages/**/docs/**
            .github/**
            scripts/**

      - name: Comment PR
        uses: actions/github-script@v8
        env:
          HAS_DOC_CHANGES: ${{ steps.diff.outputs.has_changes }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const changed = process.env.HAS_DOC_CHANGES === 'true';
            const lines = [
              '<!-- docs-regenerate -->',
              '### Docs regenerate'
            ];
            lines.push(
              changed
                ? 'Docs were regenerated and committed to this PR.'
                : 'No changes detected in docs.'
            );
            const body = lines.join('\n');
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            const existing = comments.data.find(
              (c) => c.body && c.body.includes('<!-- docs-regenerate -->')
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
