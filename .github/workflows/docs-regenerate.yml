name: PR Docs Regenerate

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  docs:
    if: github.event.issue.pull_request != null && contains(github.event.comment.body, '/docs regenerate')
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR head ref
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const {owner, repo} = context.repo;
            const prnum = context.issue.number;
            const pr = await github.rest.pulls.get({owner, repo, pull_number: prnum});
            core.setOutput('ref', pr.data.head.ref);

      - name: Checkout PR head (with submodules, writeable)
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.pr.outputs.ref || github.sha }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup PowerShell (pwsh)
        run: pwsh -v

      - name: Rebuild package docs (definitions, indexes, readmes, changelogs)
        shell: pwsh
        run: |
          function Resolve-First([string[]]$Candidates) {
            foreach ($cand in $Candidates) {
              if ([string]::IsNullOrWhiteSpace($cand)) { continue }
              $full = Join-Path (Get-Location).Path $cand
              if (Test-Path -LiteralPath $full) {
                return (Resolve-Path -LiteralPath $full).Path
              }
            }
            return $null
          }

          $mapPath = Resolve-First @(
            'scripts/schema-map.psd1',
            'scripts/schema/schema-map-postgres.psd1',
            'scripts/schema/schema-map-mysql.psd1'
          )
          if (-not $mapPath) { throw "schema map file not found" }

          $engine = ''
          if ($mapPath -match 'schema-map-(?<eng>[a-z0-9]+)\.psd1$') { $engine = $Matches.eng }

          $defsPath = Resolve-First @(
            'scripts/schema-defs.psd1',
            $(if ($engine) { "scripts/schema/schema-defs-$engine.psd1" } else { $null }),
            'scripts/schema/schema-defs-postgres.psd1',
            'scripts/schema/schema-defs-mysql.psd1'
          )
          if (-not $defsPath) { throw "schema defs file not found" }

          $packagesDir = (Resolve-Path -LiteralPath './packages').Path

          pwsh ./scripts/schema-tools/Build-Definitions.ps1 `
            -MapPath $mapPath `
            -DefsPath $defsPath `
            -PackagesDir $packagesDir `
            -Force

          pwsh ./scripts/docs/New-PackageReadmes.ps1 `
            -MapPath $mapPath `
            -PackagesDir $packagesDir `
            -Force

          pwsh ./scripts/docs/New-PackageChangelogs.ps1 `
            -MapPath $mapPath `
            -PackagesDir $packagesDir `
            -Force

          pwsh ./scripts/docs/New-DocsIndex.ps1 `
            -MapPath $mapPath `
            -PackagesDir $packagesDir `
            -OutPath ./PACKAGES.md `
            -Force

          if (Test-Path ./scripts/docs/Update-UmbrellaReadme.ps1) {
            pwsh ./scripts/docs/Update-UmbrellaReadme.ps1 `
              -ReadmePath ./README.md `
              -PackagesPath ./PACKAGES.md
          }

          pwsh ./scripts/schema-tools/Generate-MermaidERD.ps1 `
            -PackagesDir $packagesDir `
            -MapPath $mapPath `
            -OutPath ./docs/ERD.md

          pwsh ./scripts/packages/Audit-Packages.ps1 `
            -PackagesDir $packagesDir `
            -MapPath $mapPath `
            -OutPath ./docs/AUDIT.md

          pwsh ./scripts/schema-tools/Lint-Sql.ps1 `
            -PackagesDir $packagesDir `
            -MapPath $mapPath

      - name: Detect changes
        id: diff
        run: |
          git config user.email "actions@users.noreply.github.com"
          git config user.name  "GitHub Actions"
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated docs
        if: steps.diff.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: regenerate (CI)"
          commit_user_name: "blackcat-bot"
          commit_user_email: "actions@users.noreply.github.com"
          file_pattern: |
            docs/**
            packages/**/README.md
            packages/**/docs/**
            .github/**
            scripts/**

      - name: Comment PR
        uses: actions/github-script@v8
        env:
          HAS_DOC_CHANGES: ${{ steps.diff.outputs.has_changes }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const changed = process.env.HAS_DOC_CHANGES === 'true';
            const lines = [
              '<!-- docs-regenerate -->',
              '### Docs regenerate'
            ];
            lines.push(
              changed
                ? 'Docs were regenerated and committed to this PR.'
                : 'No changes detected in docs.'
            );
            const body = lines.join('\n');
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            const existing = comments.data.find(
              (c) => c.body && c.body.includes('<!-- docs-regenerate -->')
            );
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
